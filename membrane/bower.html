<!DOCTYPE html><html lang="en"><head><title>membrane/bower</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="membrane/bower"><meta name="groc-project-path" content="library/membrane/bower.coffee"><meta name="groc-github-url" content="https://github.com/ts33kr/granite"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ts33kr/granite/blob/master/library/membrane/bower.coffee">library/membrane/bower.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright (c) 2013, Alexander Cherniuk <a href="&#109;&#97;i&#108;&#x74;&#x6f;:t&#x73;&#51;&#x33;&#107;&#114;&#x40;&#103;&#109;a&#x69;&#108;&#46;c&#111;&#x6d;">t&#x73;&#51;&#x33;&#107;&#114;&#x40;&#103;&#109;a&#x69;&#108;&#46;c&#111;&#x6d;</a>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div><div class="code"><div class="wrapper"><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;lodash&quot;</span>
<span class="nv">bower = </span><span class="nx">require</span> <span class="s">&quot;bower&quot;</span>
<span class="nv">asciify = </span><span class="nx">require</span> <span class="s">&quot;asciify&quot;</span>
<span class="nv">connect = </span><span class="nx">require</span> <span class="s">&quot;connect&quot;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;winston&quot;</span>
<span class="nv">events = </span><span class="nx">require</span> <span class="s">&quot;eventemitter2&quot;</span>
<span class="nv">moment = </span><span class="nx">require</span> <span class="s">&quot;moment&quot;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&quot;assert&quot;</span>
<span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span>
<span class="nv">crypto = </span><span class="nx">require</span> <span class="s">&quot;crypto&quot;</span>
<span class="nv">nconf = </span><span class="nx">require</span> <span class="s">&quot;nconf&quot;</span>
<span class="nv">https = </span><span class="nx">require</span> <span class="s">&quot;https&quot;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>

<span class="p">{</span><span class="nx">Barebones</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./skeleton&quot;</span>
<span class="p">{</span><span class="nx">rmdirSyncRecursive</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;wrench&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This abstract base class provides the dynamic Bower support for
the services that inherit or compose this ABC. This implementation
allows for each service to have its own, isolated tree of packages
that will be dynamically installed via Bower package manager. The
implementation provides convenient way of requiring frontend libs.
Please refer to the implementation for details on the mechanics.</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports.BowerToolkit = </span><span class="k">class</span> <span class="nx">BowerToolkit</span> <span class="k">extends</span> <span class="nx">Barebones</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a marker that indicates to some internal subsystems
that this class has to be considered abstract and therefore
can not be treated as a complete class implementation. This
mainly is used to exclude or account for abstract classes.
Once inherited from, the inheritee is not abstract anymore.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@abstract</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This class definition can be used to override the mechanisms
that determine the location of the Bower collection directory
of this service. That is, where all the Bower packages will be
installed. Default is <code>undefined</code>, which will lead mechanism to
use a separate directory for this service. The directory will
have the name of the service internal, MD5 referential tagging.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@BOWER_DIRECTORY: </span><span class="kc">undefined</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Symbol declaration table, that states what keys, if those are
vectors (arrays) should be exported and then merged with their
counterparts in the destination, once the composition process
takes place. See the <code>Archetype::composition</code> hook definition
for more information. Keys are names, values can be anything.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@COMPOSITION_EXPORTS: </span><span class="nv">bowerings: </span><span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A hook that will be called prior to registering the service
implementation. Please refer to this prototype signature for
information on the parameters it accepts. Beware, this hook
is asynchronously wired in, so consult with <code>async</code> package.
Please be sure invoke the <code>next</code> arg to proceed, if relevant.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">register: </span><span class="nf">(kernel, router, next) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">isf = </span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="c1"># just a shorthand</span>
        <span class="nv">explicit = </span><span class="k">try</span> <span class="nx">@BOWER_DIRECTORY</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nv">explicit = </span><span class="nx">explicit</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">isf</span> <span class="nx">explicit</span>
        <span class="nx">assert</span> <span class="nv">isolate = </span><span class="s">&quot;%s at %s&quot;</span><span class="p">.</span><span class="nx">cyan</span> <span class="c1"># long paths</span>
        <span class="nx">assert</span> <span class="nv">disposition = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">disposition</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">reference = </span><span class="nx">disposition</span><span class="p">.</span><span class="nx">reference</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nv">idc = </span><span class="nx">explicit</span> <span class="o">or</span> <span class="nx">reference</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">kernel</span><span class="p">),</span> <span class="s">&quot;got no kernel object&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">router</span><span class="p">),</span> <span class="s">&quot;got no router object&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">next</span><span class="p">),</span> <span class="s">&quot;got no next function&quot;</span>
        <span class="nv">bowerings = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">bowerings</span> <span class="o">?=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">bowerings</span><span class="p">,</span> <span class="nf">(bowr) -&gt;</span> <span class="nx">bowr</span><span class="p">.</span><span class="nx">options</span><span class="p">)</span>
        <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">merge</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nb">Object</span><span class="p">()),</span> <span class="nx">options</span><span class="p">...</span>
        <span class="nv">directory = </span><span class="nx">kernel</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">managed</span> <span class="s">&quot;pub&quot;</span><span class="p">,</span> <span class="s">&quot;bower&quot;</span><span class="p">,</span> <span class="nx">idc</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">directory</span><span class="p">),</span> <span class="s">&quot;error with Bower dir&quot;</span>
        <span class="nv">options.directory = bowerings.directory = </span><span class="nx">directory</span>
        <span class="nv">targets = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">bowerings</span><span class="p">,</span> <span class="nf">(b) -&gt;</span> <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">target</span>
        <span class="nv">running = </span><span class="s">&quot;Configure Bower packages for %s service&quot;</span>
        <span class="nx">assert</span> <span class="nv">identify = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">running</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">identify</span><span class="p">.</span><span class="nx">underline</span> <span class="o">or</span> <span class="kc">no</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">isolate</span><span class="p">,</span> <span class="nx">identify</span><span class="p">,</span> <span class="nx">directory</span><span class="p">.</span><span class="nx">underline</span>
        <span class="k">return</span> <span class="nx">@installation</span> <span class="nx">kernel</span><span class="p">,</span> <span class="nx">targets</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">next</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This one is an internalized routine that gets preemptively
called by the Bower configuration and installation sequence
to see if the Bower installation directory has expired its
TTL that is configured. If so, the system will run a Bower
install command. If not, however, the system will silently
skip it for this service/directory. If, however, directory
does not exists - this method will not be interfering with.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">staleInstallation: </span><span class="nf">(kernel, targets, options, next) -&gt;</span>
        <span class="nv">expr = </span><span class="s">&quot;Bower directory staled %s at %s&quot;</span><span class="p">.</span><span class="nx">cyan</span>
        <span class="nx">assert</span> <span class="nv">c = current = </span><span class="nx">moment</span><span class="p">().</span><span class="nx">toDate</span><span class="p">()</span> <span class="c1"># current</span>
        <span class="nx">assert</span> <span class="nv">ident = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nv">bowerings = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">bowerings</span> <span class="o">?=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nv">ndr = </span><span class="s">&quot;could not find the Bower collector directory&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">bowerings</span><span class="p">),</span> <span class="s">&quot;no intern bowerings&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nv">dir = </span><span class="nx">bowerings</span><span class="p">.</span><span class="nx">directory</span><span class="p">),</span> <span class="nx">ndr</span>
        <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="nv">stale = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;bower:stale&quot;</span>
        <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">dir</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nv">stats = </span><span class="p">(</span><span class="k">try</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span> <span class="nx">dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">()</span> <span class="o">is</span> <span class="kc">yes</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">stale</span><span class="p">),</span> <span class="s">&quot;inval stale TTL (sec)&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">mtime = </span><span class="k">try</span> <span class="nx">moment</span> <span class="nx">stats</span><span class="p">.</span><span class="nx">mtime</span>
        <span class="nx">assert</span> <span class="nx">mtime</span><span class="p">.</span><span class="nx">add</span> <span class="s">&quot;seconds&quot;</span><span class="p">,</span> <span class="nx">stale</span> <span class="c1"># expired time</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">mtime</span><span class="p">.</span><span class="nx">fromNow</span><span class="p">().</span><span class="nx">bold</span><span class="p">,</span> <span class="nx">ident</span>
        <span class="nv">expired = </span><span class="nx">mtime</span><span class="p">.</span><span class="nx">isBefore</span><span class="p">()</span> <span class="c1"># directory expired?</span>
        <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">utimesSync</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="o">and</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">expired</span>
        <span class="nx">next</span><span class="p">();</span> <span class="k">return</span> <span class="kc">yes</span> <span class="c1"># skip install, not expired</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An internal routine that launches the actual Bower installer.
It takes a series of pre calculated parameters to be able to
perform the installation properly. Plese refer to the register
hook implementation in this ABC service for more information.
Also, refer to the method implementation for understanding.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">installation: </span><span class="nf">(kernel, targets, options, next) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">install = </span><span class="nx">bower</span><span class="p">.</span><span class="nx">commands</span><span class="p">.</span><span class="nx">install</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">bowerings = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">bowerings</span> <span class="o">?=</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">@staleInstallation</span> <span class="nx">arguments</span><span class="p">...</span>
        <span class="nx">assert</span> <span class="nv">installer = </span><span class="nx">install</span> <span class="nx">targets</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">options</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">kernel</span><span class="p">),</span> <span class="s">&quot;got no kernel object&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">next</span><span class="p">),</span> <span class="s">&quot;got no next function&quot;</span>
        <span class="nx">kernel</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">installer</span> <span class="k">if</span> <span class="nx">kernel</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">add</span>
        <span class="nx">assert</span> <span class="nv">removing = </span><span class="s">&quot;Clense (rm) Bower collector at %s&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">directory = </span><span class="nx">bowerings</span><span class="p">.</span><span class="nx">directory</span>
        <span class="nv">fwd = </span><span class="nf">(arg) =&gt;</span> <span class="nx">kernel</span><span class="p">.</span><span class="nx">domain</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nx">arg</span><span class="p">...</span>
        <span class="nv">mark = </span><span class="o">=&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">removing</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="nx">directory</span>
        <span class="nv">destroy = </span><span class="o">=&gt;</span> <span class="nx">mark</span> <span class="k">try</span> <span class="nx">rmdirSyncRecursive</span> <span class="nx">directory</span>
        <span class="nx">installer</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">destroy</span><span class="p">();</span> <span class="nx">fwd</span> <span class="nx">arguments</span>
        <span class="k">return</span> <span class="nx">installer</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;end&quot;</span><span class="p">,</span> <span class="nf">(installed) =&gt;</span> <span class="nx">do</span> <span class="o">=&gt;</span>
            <span class="nv">message = </span><span class="s">&quot;Getting Bower library %s@%s at %s&quot;</span>
            <span class="nx">assert</span> <span class="nv">bowerings.installed = </span><span class="nx">installed</span> <span class="o">or</span> <span class="mi">0</span>
            <span class="nv">fn = </span><span class="nf">(argvector) -&gt;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="kc">undefined</span>
            <span class="nx">fn</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">installed</span> <span class="o">or</span> <span class="p">[]),</span> <span class="nf">(packet) =&gt;</span>
                <span class="nx">assert</span> <span class="nv">meta = </span><span class="nx">packet</span><span class="p">.</span><span class="nx">pkgMeta</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">()</span>
                <span class="nv">name = </span><span class="p">(</span><span class="k">try</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">underline</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
                <span class="nv">version = </span><span class="p">(</span><span class="k">try</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">version</span><span class="p">.</span><span class="nx">underline</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span>
                <span class="nv">where = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
                <span class="nx">assert</span> <span class="nv">variable = </span><span class="p">[</span><span class="nx">name</span><span class="p">,</span> <span class="nx">version</span><span class="p">,</span> <span class="nx">where</span><span class="p">]</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">message</span><span class="p">.</span><span class="nx">cyan</span><span class="p">,</span> <span class="nx">variable</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This server side method is called on the context prior to the
context being compiled and flushed down to the client site. The
method is wired in an asynchronous way for greater functionality.
This is the place where you would be importing the dependencies.
Pay attention that most implementations side effect the context.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">prelude: </span><span class="nf">(symbol, context, request, next) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">list = </span><span class="nx">bower</span><span class="p">.</span><span class="nx">commands</span><span class="p">.</span><span class="nx">list</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">bowerings = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">bowerings</span> <span class="o">?=</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">cached</span> <span class="nx">context</span> <span class="k">if</span> <span class="nv">cached = </span><span class="k">try</span> <span class="nx">bowerings</span><span class="p">.</span><span class="nx">cached</span>
        <span class="k">return</span> <span class="nx">next</span> <span class="kc">undefined</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">cached</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">identify = </span><span class="k">try</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">assert</span> <span class="nv">options = directory: </span><span class="nx">bowerings</span><span class="p">.</span><span class="nx">directory</span>
        <span class="nv">message = </span><span class="s">&quot;Executing the Bower sequences in %s&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">message</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="nx">identify</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">symbol</span><span class="p">),</span> <span class="s">&quot;cannot found symbol&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">context</span><span class="p">),</span> <span class="s">&quot;located no context&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">request</span><span class="p">),</span> <span class="s">&quot;located no request&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">next</span><span class="p">),</span> <span class="s">&quot;got no next function&quot;</span>
        <span class="nv">esc = </span><span class="nf">(reg) -&gt;</span> <span class="k">new</span> <span class="nb">RegExp</span> <span class="nb">RegExp</span><span class="p">.</span><span class="nx">escape</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">reg</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">match = </span><span class="nf">(k) -&gt;</span> <span class="nf">(b) -&gt;</span> <span class="k">return</span> <span class="nx">esc</span><span class="p">(</span><span class="nx">k</span><span class="p">).</span><span class="nx">test</span> <span class="nx">b</span><span class="p">.</span><span class="nx">target</span>
        <span class="nv">sorter = </span><span class="nf">(v, k) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">findIndex</span> <span class="nx">bowerings</span><span class="p">,</span> <span class="nx">match</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nv">finder = </span><span class="nf">(v, k) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">bowerings</span><span class="p">,</span> <span class="nx">match</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nx">list</span><span class="p">(</span><span class="nv">paths: </span><span class="kc">yes</span><span class="p">,</span> <span class="nx">options</span><span class="p">).</span><span class="nx">on</span> <span class="s">&quot;end&quot;</span><span class="p">,</span> <span class="nf">(paths) =&gt;</span>
            <span class="nx">assert</span> <span class="nv">scope = </span><span class="p">[</span><span class="nx">sorter</span><span class="p">,</span> <span class="nx">finder</span><span class="p">,</span> <span class="nx">paths</span><span class="p">]</span>
            <span class="nv">bowerings.cached = </span><span class="nx">@cachier</span> <span class="nx">scope</span><span class="p">...</span>
            <span class="nx">bowerings</span><span class="p">.</span><span class="nx">cached</span> <span class="nx">context</span><span class="p">;</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This complicated definition is used to produce and then install
a method that is going to be cached and used for each request
once the initial Bower package installation is done. Please do
refer to the <code>prelude</code> implementation in this class for the info.
Please, refer to the method implementation for understanding.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">cachier: </span><span class="nf">(sorter, finder, paths) -&gt;</span> <span class="nf">(context) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">sorted = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">paths</span><span class="p">,</span> <span class="nx">sorter</span>
        <span class="nx">assert</span> <span class="nv">files = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span> <span class="nx">_</span><span class="p">.</span><span class="nx">values</span> <span class="nx">sorted</span>
        <span class="nv">locate = </span><span class="nf">(fx) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">findKey</span> <span class="nx">paths</span><span class="p">,</span> <span class="nx">resides</span><span class="p">(</span><span class="nx">fx</span><span class="p">)</span>
        <span class="nv">resides = </span><span class="nf">(f) -&gt;</span> <span class="nf">(x) -&gt;</span> <span class="nx">f</span> <span class="o">is</span> <span class="nx">x</span> <span class="o">or</span> <span class="k">try</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">x</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">sorter</span><span class="p">),</span> <span class="s">&quot;no sorter func&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">finder</span><span class="p">),</span> <span class="s">&quot;no finder func&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">context</span><span class="p">),</span> <span class="s">&quot;no contex object&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">paths</span><span class="p">),</span> <span class="s">&quot;no paths array&quot;</span>
        <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">files</span> <span class="k">then</span> <span class="nx">do</span> <span class="nf">(paths, file) -&gt;</span>
            <span class="nv">bowering = </span><span class="k">try</span> <span class="nx">finder</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">locate</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
            <span class="nv">entry = </span><span class="k">try</span> <span class="nx">bowering</span><span class="o">?</span><span class="p">.</span><span class="nx">entry</span> <span class="o">or</span> <span class="kc">undefined</span>
            <span class="nx">assert</span> <span class="nv">formatted = </span><span class="k">try</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">file</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">entry</span><span class="si">}</span><span class="s">&quot;</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">formatted</span> <span class="k">if</span> <span class="nx">entry</span>
            <span class="k">return</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">entry</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
            <span class="nv">ext = </span><span class="nf">(fxt) -&gt;</span> <span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">is</span> <span class="nx">fxt</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span> <span class="k">if</span> <span class="nx">ext</span> <span class="s">&quot;.js&quot;</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">sheets</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span> <span class="k">if</span> <span class="nx">ext</span> <span class="s">&quot;.css&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Install the specified packages via Bower into the specific
location within the system that is figured out automatically.
All packages installed via Bower will be served as the static
assets, by using the <code>pub</code> env dir. The package installation
is per service and automatically will be included in <code>prelude</code>.
Refer to the rest of methods for slightly better understanding.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@bower: </span><span class="nf">(target, entry, xoptions={}) -&gt;</span>
        <span class="nv">ent = </span><span class="s">&quot;an entrypoint has to be a valid string&quot;</span>
        <span class="nv">noTarget = </span><span class="s">&quot;target must be a Bower package spec&quot;</span>
        <span class="nv">noOptions = </span><span class="s">&quot;options must be the plain JS object&quot;</span>
        <span class="nv">message = </span><span class="s">&quot;Adding Bower package %s to service %s&quot;</span>
        <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">)</span> <span class="o">or</span> <span class="p">{}</span>
        <span class="nx">assert</span> <span class="nv">previous = </span><span class="k">this</span><span class="p">.</span><span class="nx">bowerings</span> <span class="o">or</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">previous = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span><span class="nx">previous</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="k">return</span> <span class="nx">previous</span> <span class="k">unless</span> <span class="p">(</span><span class="k">try</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">assert</span> <span class="nv">identify = id = </span><span class="k">this</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">entry</span> <span class="o">or</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">ent</span> <span class="k">if</span> <span class="nx">entry</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">options</span> <span class="o">or</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">noOptions</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">target</span> <span class="o">or</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">noTarget</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">silly</span> <span class="nx">message</span><span class="p">.</span><span class="nx">cyan</span><span class="p">,</span> <span class="nx">target</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span> <span class="nx">id</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nv">bowerings = </span><span class="nx">previous</span><span class="p">.</span><span class="nx">concat</span>
            <span class="nv">options: </span><span class="nx">options</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">()</span>
            <span class="nv">entry: </span><span class="nx">entry</span> <span class="o">or</span> <span class="kc">undefined</span>
            <span class="nv">target: </span><span class="nx">target</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span></div></div></div></div></body></html>