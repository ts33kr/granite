<!DOCTYPE html><html lang="en"><head><title>exposure/localized</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="exposure/localized"><meta name="groc-project-path" content="library/exposure/localized.coffee"><meta name="groc-github-url" content="https://github.com/ts33kr/granite"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ts33kr/granite/blob/master/library/exposure/localized.coffee">library/exposure/localized.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright (c) 2013, Alexander Cherniuk <a href="&#109;&#x61;&#x69;&#x6c;&#116;&#x6f;:&#116;&#115;&#51;&#x33;&#x6b;&#x72;&#64;&#103;&#x6d;&#97;&#x69;l&#x2e;&#x63;&#111;&#109;">&#116;&#115;&#51;&#x33;&#x6b;&#x72;&#64;&#103;&#x6d;&#97;&#x69;l&#x2e;&#x63;&#111;&#109;</a>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div><div class="code"><div class="wrapper"><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;lodash&quot;</span>
<span class="nv">yaml = </span><span class="nx">require</span> <span class="s">&quot;js-yaml&quot;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&quot;assert&quot;</span>
<span class="nv">asciify = </span><span class="nx">require</span> <span class="s">&quot;asciify&quot;</span>
<span class="nv">connect = </span><span class="nx">require</span> <span class="s">&quot;connect&quot;</span>
<span class="nv">request = </span><span class="nx">require</span> <span class="s">&quot;request&quot;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;winston&quot;</span>
<span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">nconf = </span><span class="nx">require</span> <span class="s">&quot;nconf&quot;</span>
<span class="nv">https = </span><span class="nx">require</span> <span class="s">&quot;https&quot;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&quot;util&quot;</span>

<span class="p">{</span><span class="nx">external</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;../membrane/remote&quot;</span>
<span class="p">{</span><span class="nx">Barebones</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;../membrane/skeleton&quot;</span>
<span class="p">{</span><span class="nx">Preflight</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;../membrane/preflight&quot;</span>
<span class="p">{</span><span class="nx">DuplexCore</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;../membrane/duplex&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This abstract compound provides the message localization services.
It is implemented as a tiny, but unified toolkit that includes all
the necessary instrumentation for the client site as well as for
the server site to perform text (message) internationalisation. It
shares the same concepts as I18N, Gettext and other similar kits.</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports.Localized = </span><span class="k">class</span> <span class="nx">Localized</span> <span class="k">extends</span> <span class="nx">DuplexCore</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a marker that indicates to some internal subsystems
that this class has to be considered abstract and therefore
can not be treated as a complete class implementation. This
mainly is used to exclude or account for abstract classes.
Once inherited from, the inheritee is not abstract anymore.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@abstract</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This class-defined constant is intended to be used within
the framework itself. It points to the directory that has
all the embedded translation table files. These file are
used only by the services and components that are shipped
with the framework. The ones that actually constitute it.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@EMBEDDED_LOCALE = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../../locale&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An implementation of the standard, system hook in order for
providing a static boilerplate that is used to bring up the
localization toolkit prior to the internal machinery coming
up. This is necessary to provide the ability to translating
certain services that are booted well before all the wiring.
A bit of black magic is used here, for a later refactoring.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">prelude: </span><span class="nf">(symbol, context, request, next) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">send = </span><span class="nx">context</span><span class="p">.</span><span class="nx">transit</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">context</span>
        <span class="nx">assert</span> <span class="nv">inline = </span><span class="nx">context</span><span class="p">.</span><span class="nx">inline</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">context</span>
        <span class="nx">assert</span> <span class="nv">shadow = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="k">this</span> <span class="c1"># isolated</span>
        <span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nv">session: </span><span class="nx">request</span><span class="p">.</span><span class="nx">session</span>
        <span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nv">request: </span><span class="nx">request</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nv">__isolated: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">__origin: </span><span class="nx">@</span>
        <span class="nv">translation = </span><span class="nx">@obtainTranslation</span> <span class="c1"># get provider</span>
        <span class="nv">setup = </span><span class="nx">@setupTranslationTools</span> <span class="c1"># get installer</span>
        <span class="nv">execute = </span><span class="nf">(a...) =&gt;</span> <span class="nx">translation</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nx">a</span>
        <span class="nv">spoof = </span><span class="nf">(l, c) -&gt;</span> <span class="nx">c</span> <span class="nx">@_tmpLanguage</span><span class="p">,</span> <span class="nx">@_tmpMessages</span>
        <span class="k">return</span> <span class="nx">execute</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nf">(language, messages) =&gt;</span>
            <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nx">assert</span> <span class="nv">context._tmpLanguage = </span><span class="nx">language</span>
            <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nx">assert</span> <span class="nv">context._tmpMessages = </span><span class="nx">messages</span>
            <span class="nx">send</span> <span class="nx">spoof</span><span class="p">,</span> <span class="nf">(f) -&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nv">obtainTranslation = </span><span class="nx">f</span>
            <span class="nx">send</span> <span class="nx">setup</span><span class="p">,</span> <span class="nf">(f) -&gt;</span> <span class="vi">@setupTranslationTools = </span><span class="nx">f</span>
            <span class="p">(</span><span class="nx">inline</span> <span class="nf">-&gt;</span> <span class="nx">@setupTranslationTools</span><span class="p">());</span> <span class="nx">next</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A routine intended for server side execution inside of the
services that need to use the translation toolkit during the
server side operations, such as context rendering and alike.
This routine internally uses the same code that is used when
the translation toolkit is loaded on the client side. Method
implements some of the necessary scaffolding to invoke that
same code in the standalone, server side environment itself.</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="o">::</span><span class="nv">i18n = </span><span class="k">this</span><span class="o">::</span><span class="nv">withTranslation = </span><span class="nf">(implement) -&gt;</span>
        <span class="nv">noImplement = </span><span class="s">&quot;have no implementation function&quot;</span>
        <span class="nv">noIsolation = </span><span class="s">&quot;the source scope is not isolated&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">implement</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">noImplement</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@request</span> <span class="o">or</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">noIsolation</span>
        <span class="nx">assert</span> <span class="nv">silence = </span><span class="nf">(message) -&gt;</span> <span class="c1"># empty logging fn</span>
        <span class="nx">assert</span> <span class="nv">ident = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">assert</span> <span class="nv">notify = </span><span class="s">&quot;Translation scope in %s for %s&quot;</span>
        <span class="nv">counts = </span><span class="s">&quot;Offload %s translations in %s into scope&quot;</span>
        <span class="nv">args = </span><span class="p">[</span><span class="nx">@translationLanguage</span><span class="p">,</span> <span class="nx">@translationMessages</span><span class="p">]</span>
        <span class="k">return</span> <span class="nx">implement</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">@t</span>
        <span class="k">this</span><span class="p">.</span><span class="nv">session = </span><span class="nx">@request</span><span class="p">.</span><span class="nx">session</span> <span class="k">unless</span> <span class="nx">@session</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setupTranslationTools</span> <span class="nx">silence</span><span class="p">,</span> <span class="nf">(lng, msg) =&gt;</span>
            <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">lng</span><span class="p">),</span> <span class="s">&quot;got no language&quot;</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">msg</span><span class="p">),</span> <span class="s">&quot;got no translation&quot;</span>
            <span class="k">try</span> <span class="nv">count = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">msg</span><span class="p">).</span><span class="nx">length</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">bold</span>
            <span class="k">try</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">notify</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">lng</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span> <span class="nx">ident</span>
            <span class="k">try</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">counts</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">lng</span><span class="p">.</span><span class="nx">bold</span>
            <span class="k">return</span> <span class="nx">implement</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An automatically called external routine that will take care
of setting up the client site part of the translation toolkit.
This implementation requests the necessary translation tables
off the server provider. Once is acknowledged, a client side
routines are setup and associated with the language and table.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupTranslationTools: </span><span class="nx">@awaiting</span> <span class="s">&quot;booted&quot;</span><span class="p">,</span> <span class="nf">(log, ack) -&gt;</span>
        <span class="nv">unexpected = </span><span class="s">&quot;received malformed translation&quot;</span>
        <span class="nv">unrecognized = </span><span class="s">&quot;unrecognized language received&quot;</span>
        <span class="nv">noted = </span><span class="s">&quot;loaded %s translation messages for %s&quot;</span>
        <span class="nv">sel = </span><span class="s">&quot;using %s as the language selector for %s&quot;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">@t</span> <span class="c1"># do not double call</span>
        <span class="nx">assert</span> <span class="nv">loggingRoutine = </span><span class="k">try</span> <span class="nx">log</span> <span class="o">or</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nv">sprintf = </span><span class="nx">_</span><span class="p">.</span><span class="nx">sprintf</span> <span class="c1"># format</span>
        <span class="nv">pt = </span><span class="nf">(o, v, key) -&gt;</span> <span class="k">delete</span> <span class="nx">o</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="nx">o</span><span class="p">[</span><span class="nx">lc</span> <span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
        <span class="nv">lc = </span><span class="nf">(src) =&gt;</span> <span class="k">return</span> <span class="nx">src</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">()</span>
        <span class="nv">rx = </span><span class="nf">(src) =&gt;</span> <span class="nx">@translationMessages</span><span class="o">?</span><span class="p">[</span><span class="nx">lc</span> <span class="nx">src</span><span class="p">]</span> <span class="o">or</span> <span class="nx">src</span>
        <span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">transform</span> <span class="k">this</span><span class="p">.</span><span class="nx">translationMessages</span> <span class="o">or</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pt</span>
        <span class="nx">loggingRoutine</span> <span class="s">&quot;installing the translation tookit&quot;</span>
        <span class="k">this</span><span class="p">.</span><span class="nv">t = </span><span class="nf">(s, a...) =&gt;</span> <span class="nx">sprintf</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">rx</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">...</span>
        <span class="k">this</span><span class="p">.</span><span class="nv">th = </span><span class="nf">(s, a...) =&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">humanize</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">a</span><span class="p">...</span>
        <span class="k">this</span><span class="p">.</span><span class="nv">tt = </span><span class="nf">(s, a...) =&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">titleize</span> <span class="k">this</span><span class="p">.</span><span class="nx">t</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">a</span><span class="p">...</span>
        <span class="nx">@obtainTranslation</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">(language, translation) =&gt;</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">language</span><span class="p">),</span> <span class="nx">unrecognized</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">translation</span><span class="p">),</span> <span class="nx">unexpected</span>
            <span class="nx">assert</span> <span class="vi">@translationMessages = </span><span class="nx">translation</span>
            <span class="nx">assert</span> <span class="vi">@translationLanguage = </span><span class="nx">language</span>
            <span class="nv">length = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">translation</span><span class="p">).</span><span class="nx">length</span>
            <span class="nx">loggingRoutine</span> <span class="nx">noted</span><span class="p">,</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">@service</span>
            <span class="nx">loggingRoutine</span> <span class="nx">sel</span><span class="p">,</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">@service</span>
            <span class="nx">ack</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">translation</span> <span class="k">if</span> <span class="nx">ack</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An out-of-the-box isolated provider that exposes translation
messages, provided by the service in the language requested.
If no language is explicitly asked, the compound will try to
extract the language selector out of the user session. Refer
to this provider (and compoudt) implementation for details.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">obtainTranslation: </span><span class="nx">@isolated</span> <span class="nf">(language, callback) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">compiler = </span><span class="nx">@compileTranslationMessages</span>
        <span class="nx">assert</span> <span class="nv">compiler = </span><span class="nx">compiler</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@</span> <span class="c1"># fix scoping</span>
        <span class="nx">@constructor</span><span class="p">.</span><span class="nx">compiledTranslations</span> <span class="o">?=</span> <span class="nx">compiler</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">cache = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">compiledTranslations</span>
        <span class="nx">assert</span> <span class="nv">session = </span><span class="nx">@session</span><span class="p">,</span> <span class="s">&quot;no session detected&quot;</span>
        <span class="nv">negotiator = </span><span class="k">new</span> <span class="nx">require</span><span class="p">(</span><span class="s">&quot;negotiator&quot;</span><span class="p">)</span> <span class="nx">@request</span>
        <span class="nv">neg = </span><span class="nx">negotiator</span><span class="p">.</span><span class="nx">language</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="o">or</span> <span class="p">[])</span>
        <span class="nv">selector = </span><span class="nx">language</span> <span class="o">or</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">language</span> <span class="o">or</span> <span class="nx">neg</span>
        <span class="nv">selector = </span><span class="nx">selector</span> <span class="o">or</span> <span class="s">&quot;en&quot;</span> <span class="c1"># hardcoded default</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nv">sel = </span><span class="nx">selector</span><span class="p">),</span> <span class="s">&quot;lang fail&quot;</span>
        <span class="k">delete</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">language</span> <span class="k">unless</span> <span class="nx">@session</span><span class="p">.</span><span class="nx">langlock</span>
        <span class="nx">@session</span><span class="p">.</span><span class="nx">language</span> <span class="o">?=</span> <span class="nx">sel</span> <span class="k">if</span> <span class="nx">neg</span> <span class="o">and</span> <span class="nx">sel</span> <span class="o">isnt</span> <span class="s">&quot;en&quot;</span>
        <span class="nx">assert</span> <span class="nv">messages = </span><span class="nx">cache</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">or</span> <span class="k">new</span> <span class="nb">Object</span>
        <span class="nv">amount = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">messages</span><span class="p">).</span><span class="nx">length</span> <span class="c1"># of messages</span>
        <span class="nv">banner = </span><span class="s">&quot;Loaded %s messages for %s in %s&quot;</span><span class="p">.</span><span class="nx">grey</span>
        <span class="nx">assert</span> <span class="nv">identify = </span><span class="k">try</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">()</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">banner</span><span class="p">,</span> <span class="nx">amount</span><span class="p">,</span> <span class="nx">identify</span><span class="p">,</span> <span class="nx">selector</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">callback</span><span class="p">),</span> <span class="s">&quot;invalid callback&quot;</span>
        <span class="nx">assert</span> <span class="nv">selected = </span><span class="nx">cache</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">or</span> <span class="k">new</span> <span class="nb">Object</span>
        <span class="nx">assert</span> <span class="nv">fallback = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">en</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="nx">callback</span> <span class="nx">selector</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span> <span class="nx">fallback</span><span class="p">,</span> <span class="nx">selected</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Walk over all of the declared translation message locations
and try loading messages off the every declared location. All
the messages will be merged into one object, indexed by the
languages names as keys. Colliding keys are overriden. Every
YAML document is treated as a translation for one language.
Please, never execute this method directly, since it is very
heavy on reasources and should be shadowed with the caching.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">compileTranslationMessages: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">sreader = </span><span class="nx">require</span><span class="p">(</span><span class="s">&quot;fs&quot;</span><span class="p">).</span><span class="nx">readFileSync</span>
        <span class="nx">assert</span> <span class="nv">resolve = join = </span><span class="nx">require</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">).</span><span class="nx">join</span>
        <span class="nv">identify = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nv">e = </span><span class="s">&quot;UTF-8&quot;</span> <span class="c1"># all messages files must be UTF-8</span>
        <span class="nv">collector = </span><span class="p">{}</span> <span class="c1"># will hold the translation map</span>
        <span class="nx">assert</span> <span class="nv">translations = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">translation</span><span class="p">()</span>
        <span class="nv">deduce = </span><span class="nf">(t) -&gt;</span> <span class="nv">t.f = </span><span class="nx">join</span> <span class="nx">t</span><span class="p">.</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">location</span>
        <span class="nv">t.blob = </span><span class="nx">sreader</span> <span class="nx">deduce</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">e</span> <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">translations</span>
        <span class="nv">processing = </span><span class="nf">(f) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">translations</span><span class="p">,</span> <span class="nx">f</span><span class="p">;</span> <span class="nx">collector</span>
        <span class="nx">processing</span> <span class="nf">(t) -&gt;</span> <span class="k">try</span> <span class="nx">yaml</span><span class="p">.</span><span class="nx">safeLoadAll</span> <span class="nx">t</span><span class="p">.</span><span class="nx">blob</span><span class="p">,</span> <span class="nf">(doc) -&gt;</span>
            <span class="nx">assert</span> <span class="nv">loc = </span><span class="nx">t</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span> <span class="s">&quot;got invalid location&quot;</span>
            <span class="nv">message = </span><span class="s">&quot;Get translation for %s at %s&quot;</span><span class="p">.</span><span class="nx">cyan</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">identify</span><span class="p">,</span> <span class="nx">loc</span><span class="p">.</span><span class="nx">underline</span>
            <span class="nv">noLanguage = </span><span class="s">&quot;got incorrect translation file&quot;</span>
            <span class="nx">assert</span> <span class="p">(</span><span class="nv">language = </span><span class="nx">doc</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">select</span><span class="p">]),</span> <span class="nx">noLanguage</span>
            <span class="nv">previous = </span><span class="nx">collector</span><span class="p">[</span><span class="nx">language</span><span class="p">]</span> <span class="o">or</span> <span class="k">new</span> <span class="nb">Object</span>
            <span class="nx">collector</span><span class="p">[</span><span class="nx">language</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">merge</span> <span class="nx">previous</span><span class="p">,</span> <span class="nx">doc</span>
            <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="k">delete</span> <span class="nx">collector</span><span class="p">[</span><span class="nx">language</span><span class="p">][</span><span class="nx">t</span><span class="p">.</span><span class="nx">select</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Specify the translation file for the current service. This
file is meant to contain and provide internationalization
messages. These are the strings to use for displaying with
different languages. File format is YAML with the special
structure that embeds multiple languages in a single file.
If second argument is a string, is treated as dir option.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@translation: </span><span class="nf">(location, options={}) -&gt;</span>
        <span class="nv">options = dir: </span><span class="nx">options</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">options</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nv">cwd = </span><span class="k">try</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">previous = </span><span class="nx">@translations</span> <span class="o">or</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">previous</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="c1"># get</span>
        <span class="nv">implicit = </span><span class="s">&quot;locale&quot;</span> <span class="c1"># default dir for messages</span>
        <span class="nv">noLocation = </span><span class="s">&quot;the location has to be a string&quot;</span>
        <span class="nv">noOptions = </span><span class="s">&quot;no suitable options are supplied&quot;</span>
        <span class="nv">directory = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dir</span> <span class="o">or</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">cwd</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">implicit</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">select = </span><span class="nx">options</span><span class="p">.</span><span class="nx">sel</span> <span class="o">or</span> <span class="s">&quot;$translation-language&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">location</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">noLocation</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">options</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">noOptions</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nv">translations = </span><span class="nx">previous</span><span class="p">.</span><span class="nx">concat</span>
            <span class="nv">directory: </span><span class="nx">directory</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
            <span class="nv">location: </span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
            <span class="nv">options: </span><span class="nx">options</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">()</span>
            <span class="nv">select: </span><span class="nx">select</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span></div></div></div></div></body></html>