<!DOCTYPE html><html lang="en"><head><title>nucleus/scoping</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="nucleus/scoping"><meta name="groc-project-path" content="library/nucleus/scoping.coffee"><meta name="groc-github-url" content="https://github.com/ts33kr/granite"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ts33kr/granite/blob/master/library/nucleus/scoping.coffee">library/nucleus/scoping.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright (c) 2013, Alexander Cherniuk <a href="&#109;&#x61;&#105;&#x6c;&#116;&#x6f;:&#116;&#115;&#51;3&#107;r&#64;g&#109;&#x61;&#x69;&#x6c;&#46;&#x63;&#x6f;&#109;">&#116;&#115;&#51;3&#107;r&#64;g&#109;&#x61;&#x69;&#x6c;&#46;&#x63;&#x6f;&#109;</a>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div><div class="code"><div class="wrapper"><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;lodash&quot;</span>
<span class="nv">uuid = </span><span class="nx">require</span> <span class="s">&quot;node-uuid&quot;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&quot;assert&quot;</span>
<span class="nv">connect = </span><span class="nx">require</span> <span class="s">&quot;connect&quot;</span>
<span class="nv">moment = </span><span class="nx">require</span> <span class="s">&quot;moment&quot;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;winston&quot;</span>
<span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span>
<span class="nv">nconf = </span><span class="nx">require</span> <span class="s">&quot;nconf&quot;</span>
<span class="nv">paths = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>

<span class="p">{</span><span class="nx">spawn</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;child_process&quot;</span>
<span class="p">{</span><span class="nx">rmdirSyncRecursive</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;wrench&quot;</span>
<span class="p">{</span><span class="nx">mkdirSyncRecursive</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;wrench&quot;</span>
<span class="p">{</span><span class="nx">Archetype</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./arche&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a primary gateway interface for the framework. This class
provides methods and routines necessary to bootstrap the framework
and the end user application constructed within the framework. It
is both an abstract base class as well as a ready to use bootstrap.
Please refer to the documentation of the methods for more info.</p></div></div><div class="code"><div class="wrapper"><span class="nx">assert</span> <span class="nv">module.exports.Scope = </span><span class="k">class</span> <span class="nx">Scope</span> <span class="k">extends</span> <span class="nx">Archetype</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Construct a new scope, using the supplied tag (a short name)
and a synopsis (short description of the scope) parameters.
The constructor of the scope should only associate the data.
The scope startup logic should be implemented in the method.
At its end the constructor automatically add to a registry.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">constructor: </span><span class="nf">(@tag, @synopsis, xinitialize) -&gt;</span>
        <span class="k">try</span> <span class="k">super</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">__super__</span>
        <span class="vi">@registry = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">REGISTRY</span> <span class="o">?=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="vi">@synopsis = </span><span class="s">&quot;unknown&quot;</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">@synopsis</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">@synopsis</span><span class="p">),</span> <span class="s">&quot;no valid synopsis&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@registry</span><span class="p">),</span> <span class="s">&quot;cannot get registry&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">@tag</span><span class="p">),</span> <span class="s">&quot;received an invalid tag&quot;</span>
        <span class="nv">initialize = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span> <span class="o">or</span> <span class="p">[],</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span>
        <span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">initialize</span>
        <span class="nv">exists = </span><span class="nx">@registry</span><span class="p">[</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">toUpperCase</span><span class="p">()]</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">exists</span><span class="p">,</span> <span class="s">&quot;a </span><span class="si">#{</span><span class="nx">@tag</span><span class="si">}</span><span class="s"> scope already exists&quot;</span>
        <span class="vi">@directory = </span><span class="nx">__dirname</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">@directory</span>
        <span class="nx">@registry</span><span class="p">[</span><span class="nx">@tag</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">toUpperCase</span><span class="p">()]</span> <span class="o">=</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This method is responsible for starting up the scope object.
This means initialization of all its necessary routines and
setting up whatever this scope needs to set. The default
implementation takes care only of loading the proper config.
The kernel invokes this prior to proceeding its operations.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">incorporate: </span><span class="nf">(kernel) -&gt;</span>
        <span class="nv">assumption = </span><span class="s">&quot;Assuming %s as the configuration&quot;</span>
        <span class="nv">incorporate = </span><span class="s">&quot;Incorporating the %s config scope&quot;</span>
        <span class="nv">noOverrides = </span><span class="s">&quot;got no valid overrides (required)&quot;</span>
        <span class="nx">assert</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">overrides</span> <span class="nx">@overrides</span> <span class="o">?=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">@overrides</span><span class="p">),</span> <span class="nx">noOverrides</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">conf = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;layout:config&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nv">file = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">conf</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@tag</span><span class="si">}</span><span class="s">.json&quot;</span>
        <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="k">try</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">incorporate</span><span class="p">.</span><span class="nx">cyan</span><span class="p">,</span> <span class="nx">@tag</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">assumption</span><span class="p">.</span><span class="nx">cyan</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">underline</span>
        <span class="nx">nconf</span><span class="p">.</span><span class="nx">file</span> <span class="nx">file</span> <span class="k">if</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">file</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">@defaults</span> <span class="o">?=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="k">for</span> <span class="nx">directory</span> <span class="k">in</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;env:dirs&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
            <span class="nv">m = </span><span class="s">&quot;Environment mkdir at %s using 0%s mode&quot;</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nv">mode = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;env:mode&quot;</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">o = </span><span class="nx">mode</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="nx">bold</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">m</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="nx">directory</span><span class="p">.</span><span class="nx">underline</span><span class="p">,</span> <span class="nx">o</span>
            <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nx">mkdirSyncRecursive</span> <span class="nx">directory</span><span class="p">,</span> <span class="nx">mode</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This method is responsible for shutting down the scope object.
This means stripping down all the necessary routines and other
resources that are mandated by this this scope object. Default
implementation does not do almost anything, so it is up to you.
The kernel invokes this after the shutting down its operations.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">disintegrate: </span><span class="nf">(kernel) -&gt;</span>
        <span class="nv">location = </span><span class="s">&quot;Used %s as the configuration&quot;</span>
        <span class="nv">message = </span><span class="s">&quot;Disintegrating the %s configuration&quot;</span>
        <span class="nx">assert</span> <span class="nv">preserve = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;env:preserve&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="nx">assert</span> <span class="nv">conf = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;layout:config&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">@tag</span><span class="p">),</span> <span class="s">&quot;malformed scope tag&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nv">file = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">conf</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@tag</span><span class="si">}</span><span class="s">.json&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">@tag</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">location</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="k">try</span> <span class="nx">file</span><span class="p">.</span><span class="nx">underline</span>
        <span class="k">for</span> <span class="nx">directory</span> <span class="k">in</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;env:dirs&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[]</span>
            <span class="nv">w = </span><span class="s">&quot;Wiping out entire %s env directory&quot;</span>
            <span class="nv">p = </span><span class="s">&quot;Preserving %s environment directory&quot;</span>
            <span class="nv">c = preserving = </span><span class="k">try</span> <span class="nx">directory</span> <span class="k">in</span> <span class="nx">preserve</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">p</span><span class="p">.</span><span class="nx">red</span><span class="p">,</span> <span class="nx">directory</span><span class="p">.</span><span class="nx">underline</span> <span class="k">if</span> <span class="nx">c</span>
            <span class="k">continue</span> <span class="k">if</span> <span class="nx">preserving</span> <span class="c1"># skipping preserved</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">w</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="nx">directory</span><span class="p">.</span><span class="nx">underline</span>
            <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nx">rmdirSyncRecursive</span> <span class="nx">directory</span><span class="p">,</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Try looking up and fetching a scope of the scope registry that
matches the predicate. The predicate can be either the string
that specifies the value of its scope to look for, or function
that will be used to find the matching scope. If the tag name
is used, it will be upper cased, to follow to the conventions.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@lookup: </span><span class="nf">(predicate) -&gt;</span>
        <span class="nv">message = </span><span class="s">&quot;Looking up the %s scoping object&quot;</span>
        <span class="nv">registry = </span><span class="k">this</span><span class="p">.</span><span class="nx">REGISTRY</span> <span class="o">?=</span> <span class="k">try</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">adapting = </span><span class="nx">_</span><span class="p">.</span><span class="nx">values</span> <span class="nx">registry</span>
        <span class="nv">comparison = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">predicate</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">functional = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">predicate</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">comparing = </span><span class="nf">(v) -&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">is</span> <span class="nx">predicate</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">registry</span><span class="p">),</span> <span class="s">&quot;cannot get registry&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">message</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="k">try</span> <span class="nx">predicate</span><span class="p">.</span><span class="nx">underline</span>
        <span class="nv">predicate = </span><span class="nx">predicate</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="k">if</span> <span class="nx">comparison</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">adapting</span><span class="p">,</span> <span class="nx">predicate</span> <span class="k">if</span> <span class="nx">functional</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">adapting</span><span class="p">,</span> <span class="nx">comparing</span> <span class="k">if</span> <span class="nx">comparison</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;could not find requested scope&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Get a concatenated path to the unique path designed by the
combination of prefix and a unique identificator generated by
employing the UUID v4 format. If unique param is set to false
than the path will be set to prefix without the unique part.
The basis has to be one of the managed environment directory.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">managed: </span><span class="p">(</span><span class="nx">basis</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">unique</span><span class="o">=</span><span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">())</span> <span class="nf">-&gt;</span>
        <span class="nv">unknown = </span><span class="s">&quot;an env dir </span><span class="si">#{</span><span class="nx">basis</span><span class="si">}</span><span class="s"> is not managed&quot;</span>
        <span class="nx">assert</span> <span class="nv">pool = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;env:dirs&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">prefix</span><span class="p">),</span> <span class="s">&quot;invalid dir prefix&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">pool</span><span class="p">),</span> <span class="s">&quot;invalid directory pool&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">prefix</span><span class="p">),</span> <span class="s">&quot;got empty prefix&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">pool</span><span class="p">),</span> <span class="s">&quot;empty directories&quot;</span>
        <span class="nx">assert</span> <span class="nx">basis</span> <span class="o">and</span> <span class="p">(</span><span class="nx">basis</span> <span class="k">in</span> <span class="nx">pool</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">unknown</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nv">prefix = </span><span class="nx">prefix</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">unique</span> <span class="k">if</span> <span class="nx">unique</span>
        <span class="k">return</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">basis</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span></div></div></div></div></body></html>