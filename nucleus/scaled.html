<!DOCTYPE html><html lang="en"><head><title>nucleus/scaled</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="nucleus/scaled"><meta name="groc-project-path" content="library/nucleus/scaled.coffee"><meta name="groc-github-url" content="https://github.com/ts33kr/granite"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ts33kr/granite/blob/master/library/nucleus/scaled.coffee">library/nucleus/scaled.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright (c) 2013, Alexander Cherniuk <a href="&#109;&#97;&#x69;l&#116;&#111;:&#116;&#115;&#51;&#x33;&#107;&#x72;&#x40;&#103;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;m">&#116;&#115;&#51;&#x33;&#107;&#x72;&#x40;&#103;&#x6d;&#97;&#105;&#108;&#x2e;&#x63;&#x6f;m</a>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div><div class="code"><div class="wrapper"><span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;lodash&quot;</span>
<span class="nv">asciify = </span><span class="nx">require</span> <span class="s">&quot;asciify&quot;</span>
<span class="nv">connect = </span><span class="nx">require</span> <span class="s">&quot;connect&quot;</span>
<span class="nv">seaport = </span><span class="nx">require</span> <span class="s">&quot;seaport&quot;</span>
<span class="nv">Keygrip = </span><span class="nx">require</span> <span class="s">&quot;keygrip&quot;</span>
<span class="nv">Cookies = </span><span class="nx">require</span> <span class="s">&quot;cookies&quot;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;winston&quot;</span>
<span class="nv">uuid = </span><span class="nx">require</span> <span class="s">&quot;node-uuid&quot;</span>
<span class="nv">moment = </span><span class="nx">require</span> <span class="s">&quot;moment&quot;</span>
<span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&quot;assert&quot;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">nconf = </span><span class="nx">require</span> <span class="s">&quot;nconf&quot;</span>
<span class="nv">https = </span><span class="nx">require</span> <span class="s">&quot;https&quot;</span>
<span class="nv">paths = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>

<span class="p">{</span><span class="nx">format</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="p">{</span><span class="nx">GraniteKernel</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./kernel&quot;</span>
<span class="p">{</span><span class="nx">HttpProxy</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;http-proxy&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the descendant of the generic kernel that implements the
scaling of the framework across an arbitrary clustered processes
or even machines. It is built on top of a set of the Node.js based
technologies, such as service discovery library alongside with a
library that allows for effective proxying of the HTTP requests.
Normally this kernel should always be preferred over Generic one!</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports.ScaledKernel = </span><span class="k">class</span> <span class="nx">ScaledKernel</span> <span class="k">extends</span> <span class="nx">GraniteKernel</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This sets up the default identica for this kernel. It forms
an identica of a certain recommended format and populates it
with data takes from the <code>FRAMEWORK</code> definition in <code>Generic</code>
kernel. Refer to that kernel and to <code>identica</code> method there
for more information on semantics and the way of working it.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@identica</span> <span class="nf">-&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@APPLICATION</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">@</span><span class="si">#{</span><span class="nx">@APPLICATION</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="s">&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prepare and setup an HTTPS master server. This server is the
proxy server that is going to consume all the HTTPS requests
and load balance the request to some of the instances. Please
refer to the <code>node-http-proxy</code> library for info on the proxy.
Also see <code>makeForward</code> method for details on load balancing!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startupHttpsMaster: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">q = </span><span class="nx">@queueOfHttps</span> <span class="o">?=</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">options = </span><span class="nx">@resolveSslDetails</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">host = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;master:host&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nv">port = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;master:https&quot;</span>
        <span class="nx">assert</span> <span class="nv">registr = </span><span class="nx">@makeRegistrar</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="nx">assert</span> <span class="nv">selectr = </span><span class="nx">@makeSelectors</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="nx">assert</span> <span class="nv">forward = </span><span class="nx">@makeForwarder</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="nx">selectr</span>
        <span class="nx">assert</span> <span class="nv">upgrade = </span><span class="nx">@makeUpgraders</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="nx">selectr</span>
        <span class="nv">remove = </span><span class="nf">(s) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">q</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">is</span> <span class="nx">x</span><span class="p">.</span><span class="nx">uuid</span>
        <span class="vi">@secureProxy = </span><span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">forward</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">@domain</span><span class="p">;</span> <span class="nx">@domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@secureProxy</span>
        <span class="nx">assert</span> <span class="nx">@secureProxy</span><span class="p">;</span> <span class="nx">@secureProxy</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span>
        <span class="nx">@secureProxy</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;upgrade&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">upgrade</span> <span class="nx">arguments</span><span class="p">...</span>
        <span class="nx">assert</span> <span class="nv">running = </span><span class="s">&quot;Master HTTPS server at %s&quot;</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nv">location = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">running</span><span class="p">.</span><span class="nx">underline</span><span class="p">.</span><span class="nx">magenta</span><span class="p">,</span> <span class="nx">location</span>
        <span class="nx">@spserver</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;free&quot;</span><span class="p">,</span> <span class="nf">(service) -&gt;</span> <span class="nx">remove</span> <span class="nx">service</span>
        <span class="nx">@spserver</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;register&quot;</span><span class="p">,</span> <span class="nx">registr</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prepare and setup an HTTP master server. This server is the
proxy server that is going to consume all the HTTP requests
and load balance the request to some of the instances. Please
refer to the <code>node-http-proxy</code> library for info on the proxy.
Also see <code>makeForward</code> method for details on load balancing!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startupHttpMaster: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">q = </span><span class="nx">@queueOfHttp</span> <span class="o">?=</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">host = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;master:host&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nv">port = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;master:http&quot;</span>
        <span class="nx">assert</span> <span class="nv">registr = </span><span class="nx">@makeRegistrar</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="nx">assert</span> <span class="nv">selectr = </span><span class="nx">@makeSelectors</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="nx">assert</span> <span class="nv">forward = </span><span class="nx">@makeForwarder</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="nx">selectr</span>
        <span class="nx">assert</span> <span class="nv">upgrade = </span><span class="nx">@makeUpgraders</span> <span class="nx">q</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="nx">selectr</span>
        <span class="nv">remove = </span><span class="nf">(s) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">q</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">is</span> <span class="nx">x</span><span class="p">.</span><span class="nx">uuid</span>
        <span class="nx">assert</span> <span class="vi">@serverProxy = </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">forward</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">@domain</span><span class="p">;</span> <span class="nx">@domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@serverProxy</span>
        <span class="nx">assert</span> <span class="nx">@serverProxy</span><span class="p">;</span> <span class="nx">@serverProxy</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span>
        <span class="nx">@serverProxy</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;upgrade&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">upgrade</span> <span class="nx">arguments</span><span class="p">...</span>
        <span class="nx">assert</span> <span class="nv">running = </span><span class="s">&quot;Master HTTP server at %s&quot;</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nv">location = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">running</span><span class="p">.</span><span class="nx">underline</span><span class="p">.</span><span class="nx">magenta</span><span class="p">,</span> <span class="nx">location</span>
        <span class="nx">@spserver</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;free&quot;</span><span class="p">,</span> <span class="nf">(service) -&gt;</span> <span class="nx">remove</span> <span class="nx">service</span>
        <span class="nx">@spserver</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;register&quot;</span><span class="p">,</span> <span class="nx">registr</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a factory method that produces handlers invoked on
discovering a new service on the Seaport hub. This handler
examines the service to decide if it suits the parameters
passed to the factory, and if so - add it to the registry
of available services that are rotated using round-robin.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">makeRegistrar: </span><span class="nf">(queue, kind) -&gt;</span> <span class="nf">(service) =&gt;</span>
        <span class="nv">config = </span><span class="nb">Object</span> <span class="nv">https: </span><span class="nx">kind</span> <span class="o">is</span> <span class="s">&quot;https&quot;</span>
        <span class="nx">assert</span> <span class="nv">ids = </span><span class="k">try</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">identica</span><span class="p">()</span>
        <span class="nv">compile = </span><span class="nf">(s) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">s</span><span class="p">.</span><span class="nx">role</span><span class="si">}</span><span class="s">@</span><span class="si">#{</span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">return</span> <span class="kc">undefined</span> <span class="k">unless</span> <span class="nx">service</span><span class="p">.</span><span class="nx">kind</span> <span class="o">is</span> <span class="nx">kind</span>
        <span class="k">return</span> <span class="kc">undefined</span> <span class="k">unless</span> <span class="nx">compile</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span> <span class="o">is</span> <span class="nx">ids</span>
        <span class="nv">options = </span><span class="nx">@resolveSslDetails</span><span class="p">()</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">https</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">config</span><span class="p">,</span> <span class="nv">https: </span><span class="nx">options</span> <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">https</span>
        <span class="nv">where = host: </span><span class="nx">service</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">service</span><span class="p">.</span><span class="nx">port</span>
        <span class="nx">assert</span> <span class="nv">merged = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">config</span><span class="p">,</span> <span class="nv">target: </span><span class="nx">where</span>
        <span class="nv">merged.target.https = </span><span class="nx">service</span><span class="p">.</span><span class="nx">kind</span> <span class="o">is</span> <span class="s">&quot;https&quot;</span>
        <span class="nv">merged.target.rejectUnauthorized = </span><span class="kc">false</span>
        <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span> <span class="nv">proxy = </span><span class="k">new</span> <span class="nx">HttpProxy</span> <span class="nx">merged</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">proxy.uuid = </span><span class="nx">service</span><span class="p">.</span><span class="nx">uuid</span>
        <span class="nx">proxy</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;proxyError&quot;</span><span class="p">,</span> <span class="nf">(err, req, res) =&gt;</span>
            <span class="nv">msg = </span><span class="s">&quot;got an error talking to backend: %s&quot;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&quot;a proxy backend error&quot;</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">format</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a factory method that produces methods that dispatch
requests to the corresponding backend proxied server. It is
the direct implementor of the round-robin rotation algorithm.
Beware howeber that is also implements the sticky session algo
based on setting and getting the correctly signed req cookies.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">makeSelectors: </span><span class="nf">(queue, kind) -&gt;</span> <span class="nf">(request, response) =&gt;</span>
        <span class="nv">encrypted = </span><span class="nx">request</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">encrypted</span> <span class="o">or</span> <span class="kc">no</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nv">ttl = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;balancer:ttl&quot;</span>
        <span class="nv">response.set = </span><span class="kc">yes</span> <span class="c1"># a hack for `cookies` module</span>
        <span class="nv">response.getHeader = </span><span class="nf">(key) -&gt;</span> <span class="p">[</span><span class="nx">key</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()]</span>
        <span class="nv">ltp = </span><span class="nf">(u) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">queue</span><span class="p">,</span> <span class="nf">(srv) -&gt;</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">uuid</span> <span class="o">is</span> <span class="nx">u</span>
        <span class="nv">rrb = </span><span class="nf">-&gt;</span> <span class="nx">assert</span> <span class="nv">p = </span><span class="nx">queue</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">push</span> <span class="nx">p</span><span class="p">;</span> <span class="nx">p</span>
        <span class="nv">sticky = </span><span class="s">&quot;Sticky %s request %s of %s&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">url = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">underline</span><span class="p">.</span><span class="nx">yellow</span>
        <span class="nx">assert</span> <span class="nv">x = </span><span class="p">(</span><span class="nx">encrypted</span> <span class="o">and</span> <span class="s">&quot;HTTPS&quot;</span> <span class="o">or</span> <span class="s">&quot;HTTP&quot;</span><span class="p">).</span><span class="nx">bold</span>
        <span class="nx">assert</span> <span class="nv">secret = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;session:secret&quot;</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">keygrip = </span><span class="k">new</span> <span class="nx">Keygrip</span> <span class="p">[</span><span class="nx">secret</span><span class="p">],</span> <span class="s">&quot;sha256&quot;</span><span class="p">,</span> <span class="s">&quot;hex&quot;</span>
        <span class="nv">cookies = </span><span class="k">new</span> <span class="nx">Cookies</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">keygrip</span>
        <span class="nv">xbackend = </span><span class="nx">cookies</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;xbackend&quot;</span><span class="p">,</span> <span class="nv">signed: </span><span class="kc">yes</span>
        <span class="k">return</span> <span class="nx">rrb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;balancer:sticky&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">proxy = </span><span class="nx">ltp</span><span class="p">(</span><span class="nx">xbackend</span><span class="p">)</span> <span class="o">or</span> <span class="nx">rrb</span><span class="p">()</span>
        <span class="nv">configure = signed: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">overwrite: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">httpOnly: </span><span class="kc">no</span>
        <span class="nv">configure.expires = </span><span class="nx">moment</span><span class="p">().</span><span class="nx">add</span><span class="p">(</span><span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="nx">ttl</span><span class="p">).</span><span class="nx">toDate</span><span class="p">()</span>
        <span class="nv">s = </span><span class="nx">cookies</span><span class="p">.</span><span class="nx">set</span> <span class="s">&quot;xbackend&quot;</span><span class="p">,</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">uuid</span><span class="p">,</span> <span class="nx">configure</span>
        <span class="nv">a = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">assert</span> <span class="nv">a = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">underline</span><span class="p">.</span><span class="nx">yellow</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">sticky</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">a</span> <span class="k">if</span> <span class="nx">xbackend</span>
        <span class="nx">assert</span> <span class="nx">s</span><span class="p">.</span><span class="nx">response</span> <span class="o">is</span> <span class="nx">response</span><span class="p">;</span> <span class="k">return</span> <span class="nx">proxy</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a factory method that produces request forwarders.
These are directly responsible for proxying an HTTP request
from the master server (frontend) to actual server (backend)
that does the job of handling the request. The forwarder is
also responsible for rotating (round-robin) servers queue!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">makeForwarder: </span><span class="nf">(queue, kind, select) -&gt;</span> <span class="nf">(xrequest, xresponse) =&gt;</span>
        <span class="nx">assert</span> <span class="nv">request = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">,</span> <span class="s">&quot;connection&quot;</span>
        <span class="nx">assert</span> <span class="nv">response = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">,</span> <span class="s">&quot;writeHead&quot;</span>
        <span class="nv">encrypted = </span><span class="nx">request</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">encrypted</span> <span class="o">or</span> <span class="kc">false</span>
        <span class="nx">assert</span> <span class="nv">u = </span><span class="k">try</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">underline</span><span class="p">.</span><span class="nx">yellow</span>
        <span class="nx">assert</span> <span class="nv">x = </span><span class="p">(</span><span class="nx">encrypted</span> <span class="o">and</span> <span class="s">&quot;HTTPS&quot;</span> <span class="o">or</span> <span class="s">&quot;HTTP&quot;</span><span class="p">).</span><span class="nx">bold</span>
        <span class="nv">reason = </span><span class="s">&quot;no instances found behind a frontend&quot;</span>
        <span class="nv">msg = </span><span class="s">&quot;the frontend has no instances to talk to&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">queue</span><span class="p">),</span> <span class="s">&quot;got invalid proxy queue&quot;</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">504</span><span class="p">,</span> <span class="nx">reason</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">queue</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">and</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">queue</span>
        <span class="nx">assert</span> <span class="nv">proxy = </span><span class="k">try</span> <span class="nx">select</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span>
        <span class="nv">a = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">assert</span> <span class="nv">a = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">underline</span><span class="p">.</span><span class="nx">yellow</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Proxy %s request %s to %s&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">a</span>
        <span class="k">return</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">proxyRequest</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a factory method that that produces the specialized
request handler that is fired when an <code>upgrade</code> is requested
on one of the master servers. This is the functionality that
is required for WebSockets and other similar transports to
perform its operation correctly in a distributed environment.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">makeUpgraders: </span><span class="nf">(queue, kind, select) -&gt;</span> <span class="nf">(xrequest, xsocket) =&gt;</span>
        <span class="nx">assert</span> <span class="nv">request = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">,</span> <span class="s">&quot;connection&quot;</span>
        <span class="nx">assert</span> <span class="nv">response = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">,</span> <span class="s">&quot;localAddress&quot;</span>
        <span class="nv">response.writeHead = </span><span class="nx">http</span><span class="p">.</span><span class="nx">ServerResponse</span><span class="o">::</span><span class="nx">writeHead</span>
        <span class="nv">encrypted = </span><span class="nx">request</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">encrypted</span> <span class="o">or</span> <span class="kc">false</span>
        <span class="nx">assert</span> <span class="nv">u = </span><span class="k">try</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">underline</span><span class="p">.</span><span class="nx">yellow</span>
        <span class="nx">assert</span> <span class="nv">x = </span><span class="p">(</span><span class="nx">encrypted</span> <span class="o">and</span> <span class="s">&quot;HTTPS&quot;</span> <span class="o">or</span> <span class="s">&quot;HTTP&quot;</span><span class="p">).</span><span class="nx">bold</span>
        <span class="nv">msg = </span><span class="s">&quot;the frontend has no instances to talk to&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">queue</span><span class="p">),</span> <span class="s">&quot;got invalid proxy queue&quot;</span>
        <span class="nv">reason = r = </span><span class="s">&quot;no instances found behind a frontend&quot;</span>
        <span class="k">try</span> <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">504</span><span class="p">,</span> <span class="nx">r</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">queue</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="o">and</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">queue</span>
        <span class="nx">assert</span> <span class="nv">proxy = </span><span class="k">try</span> <span class="nx">select</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span>
        <span class="nv">a = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">assert</span> <span class="nv">a = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">a</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">underline</span><span class="p">.</span><span class="nx">yellow</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Proxy %s upgrade %s to %s&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">a</span>
        <span class="k">return</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">proxyWebSocketRequest</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create and launch a Seaport server in the current kernel. It
draws the configuration from the same key as Seaport client
uses. This routine should only be invoked when the kernel is
launched in the master mode, generally. The method wires in
some handlers into the Seaport to track hosts come and go.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">createSeaportServer: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">r = </span><span class="s">&quot;New %s service %s at %s&quot;</span><span class="p">.</span><span class="nx">green</span>
        <span class="nx">assert</span> <span class="nv">f = </span><span class="s">&quot;No %s service %s at %s&quot;</span><span class="p">.</span><span class="nx">yellow</span>
        <span class="nv">create = </span><span class="s">&quot;Created the Seaport server at %s&quot;</span>
        <span class="nx">assert</span> <span class="nv">identica = </span><span class="k">try</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">identica</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">host = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;hub:host&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nv">port = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;hub:port&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">opts = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;hub:opts&quot;</span>
        <span class="nv">k = </span><span class="nf">(srv) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">srv</span><span class="p">.</span><span class="nx">kind</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">().</span><span class="nx">bold</span>
        <span class="nv">c = </span><span class="nf">(srv) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">srv</span><span class="p">.</span><span class="nx">role</span><span class="si">}</span><span class="s">@</span><span class="si">#{</span><span class="nx">srv</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nv">l = </span><span class="nf">(srv) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">srv</span><span class="p">.</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">srv</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">underline</span>
        <span class="nv">log = </span><span class="nf">(m, s) -&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">k</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span> <span class="nx">c</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span> <span class="nx">l</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
        <span class="nv">match = </span><span class="nf">(s) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">s</span><span class="p">.</span><span class="nx">role</span><span class="si">}</span><span class="s">@</span><span class="si">#{</span><span class="nx">s</span><span class="p">.</span><span class="nx">version</span><span class="si">}</span><span class="s">&quot;</span> <span class="o">is</span> <span class="nx">identica</span>
        <span class="nx">assert</span> <span class="vi">@spserver = </span><span class="nx">seaport</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">opts</span> <span class="o">or</span> <span class="p">{}</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">@domain</span><span class="p">;</span> <span class="k">try</span> <span class="nx">@domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@spserver</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">create</span><span class="p">.</span><span class="nx">magenta</span><span class="p">,</span> <span class="nx">l</span><span class="p">(</span><span class="nv">host: </span><span class="nx">host</span><span class="p">,</span> <span class="nv">port: </span><span class="nx">port</span><span class="p">)</span>
        <span class="nx">@spserver</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;register&quot;</span><span class="p">,</span> <span class="nf">(s) -&gt;</span> <span class="nx">log</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">match</span> <span class="nx">s</span>
        <span class="nx">@spserver</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;free&quot;</span><span class="p">,</span> <span class="nf">(s) -&gt;</span> <span class="nx">log</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">s</span> <span class="k">if</span> <span class="nx">match</span> <span class="nx">s</span>
        <span class="k">try</span> <span class="nx">@spserver</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span> <span class="k">catch</span> <span class="nx">error</span>
            <span class="nv">message = </span><span class="s">&quot;Seaport server failed\r\n%s&quot;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="nx">message</span><span class="p">.</span><span class="nx">red</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">stack</span>
            <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup and launch either HTTP or HTTPS servers to listen at
the configured addresses and ports. This method reads up the
scoping configuration in order to obtain the data necessary
for instantiating, configuring and launching up the servers.
This version goes to the Seaport hub to obtain the options!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startupHttpsServer: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">type = </span><span class="s">&quot;https&quot;</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">().</span><span class="nx">bold</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">config = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@seaport</span><span class="p">),</span> <span class="s">&quot;got no seaport&quot;</span>
        <span class="nv">msg = </span><span class="s">&quot;Got </span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s"> port from the Seaport: %s&quot;</span>
        <span class="nx">assert</span> <span class="nv">identica = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identica</span><span class="p">()</span>
        <span class="nv">cfg = config: </span><span class="nx">config</span><span class="p">,</span> <span class="nv">identica: </span><span class="nx">identica</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nv">host: </span><span class="k">try</span> <span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">host</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nv">uuid: </span><span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">(),</span> <span class="nv">kind: </span><span class="s">&quot;https&quot;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nv">token: </span><span class="nx">@token</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nv">record = </span><span class="nx">@seaport</span><span class="p">.</span><span class="nx">register</span> <span class="nx">identica</span><span class="p">,</span> <span class="nx">cfg</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">record</span><span class="p">),</span> <span class="s">&quot;got mistaken&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">green</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">record</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">bold</span>
        <span class="k">try</span> <span class="nv">config.server.https = </span><span class="nx">record</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">config</span><span class="p">;</span> <span class="k">return</span> <span class="k">super</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup and launch either HTTP or HTTPS servers to listen at
the configured addresses and ports. This method reads up the
scoping configuration in order to obtain the data necessary
for instantiating, configuring and launching up the servers.
This version goes to the Seaport hub to obtain the options!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startupHttpServer: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">type = </span><span class="s">&quot;http&quot;</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">().</span><span class="nx">bold</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">config = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@seaport</span><span class="p">),</span> <span class="s">&quot;got no seaport&quot;</span>
        <span class="nv">msg = </span><span class="s">&quot;Got </span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s"> port from the Seaport: %s&quot;</span>
        <span class="nx">assert</span> <span class="nv">identica = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identica</span><span class="p">()</span>
        <span class="nv">cfg = config: </span><span class="nx">config</span><span class="p">,</span> <span class="nv">identica: </span><span class="nx">identica</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nv">host: </span><span class="k">try</span> <span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">host</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nv">uuid: </span><span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">(),</span> <span class="nv">kind: </span><span class="s">&quot;http&quot;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">cfg</span><span class="p">,</span> <span class="nv">token: </span><span class="nx">@token</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nv">record = </span><span class="nx">@seaport</span><span class="p">.</span><span class="nx">register</span> <span class="nx">identica</span><span class="p">,</span> <span class="nx">cfg</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">record</span><span class="p">),</span> <span class="s">&quot;got mistaken&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">green</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">record</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">bold</span>
        <span class="k">try</span> <span class="nv">config.server.http = </span><span class="nx">record</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">config</span><span class="p">;</span> <span class="k">return</span> <span class="k">super</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A configuration routine that ensures the scope config has the
Seaport hub related configuration data. If so, it proceeds to
retrieving that info and using it to locate and connect to a
Seaport hub, which is then installed as the kernel instance
variable, so that it can be accessed by the other routines.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@configure</span> <span class="s">&quot;access the service Seaport hub&quot;</span><span class="p">,</span> <span class="nf">(next) -&gt;</span>
        <span class="nv">nh = </span><span class="s">&quot;no Seaport host found in the configuration&quot;</span>
        <span class="nv">np = </span><span class="s">&quot;no Seaport port found in the configuration&quot;</span>
        <span class="nv">nt = </span><span class="s">&quot;no Seaport opts found in the configuration&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nv">host = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;hub:host&quot;</span><span class="p">),</span> <span class="nx">nh</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nv">port = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;hub:port&quot;</span><span class="p">),</span> <span class="nx">np</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nv">opts = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;hub:opts&quot;</span><span class="p">),</span> <span class="nx">nt</span>
        <span class="k">this</span><span class="p">.</span><span class="nv">seaport = </span><span class="nx">seaport</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">opts</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@seaport</span><span class="p">),</span> <span class="s">&quot;seaport failed&quot;</span>
        <span class="nx">assert</span> <span class="nx">@seaport</span><span class="p">.</span><span class="nx">register</span><span class="o">?</span><span class="p">,</span> <span class="s">&quot;a broken seaport&quot;</span>
        <span class="nv">shl = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">host</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nv">msg = </span><span class="s">&quot;Locate a Seaport hub at </span><span class="si">#{</span><span class="nx">shl</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">blue</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">msg</span><span class="p">;</span> <span class="k">return</span> <span class="nx">next</span> <span class="kc">undefined</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The kernel preemption routine is called once the kernel has
passed the initial launching and configuration phase, but is
yet to start up the router, connect services and instantiate
an actual application. This method gets passes continuation
that does that. The method can either invoke it or omit it.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">kernelPreemption: </span><span class="nf">(continuation) -&gt;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@options</span><span class="p">),</span> <span class="s">&quot;got no options&quot;</span>
        <span class="nv">either = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">master</span> <span class="o">or</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">instance</span>
        <span class="nx">assert</span> <span class="nx">either</span><span class="p">,</span> <span class="s">&quot;no master and no instance mode&quot;</span>
        <span class="k">return</span> <span class="nx">continuation</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">master</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;The kernel is booting as master&quot;</span>
        <span class="nx">assert</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;master&quot;</span><span class="p">),</span> <span class="s">&quot;no master config&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@createSeaportServer</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@startupHttpsMaster</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@startupHttpMaster</span><span class="p">()</span>
        <span class="nx">continuation</span><span class="p">.</span><span class="nx">call</span> <span class="nx">@</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">instance</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Shutdown the kernel instance. This includes shutting down both
HTTP and HTTPS server that may be running, stopping the router
and unregistering all the services as a precauting. After that
the scope is being dispersed and some events are being emited.
This implementaton cleans up some of the scalability resources.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">shutdownKernel: </span><span class="nf">(reason, eol=yes) -&gt;</span>
        <span class="k">try</span> <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="nx">require</span><span class="p">(</span><span class="s">&quot;os&quot;</span><span class="p">).</span><span class="nx">EOL</span> <span class="k">if</span> <span class="nx">eol</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;killed-scaled-kernel&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
        <span class="nv">message = </span><span class="s">&quot;Graceful shutdown of Scaled kernel&quot;</span>
        <span class="k">try</span> <span class="nx">@spserver</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@spserver</span><span class="p">.</span><span class="nx">close</span><span class="o">?</span>
        <span class="k">try</span> <span class="nx">@serverProxy</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@serverProxy</span><span class="o">?</span>
        <span class="k">try</span> <span class="nx">@secureProxy</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@secureProxy</span><span class="o">?</span>
        <span class="nv">terminator = </span><span class="nf">(proxy) -&gt;</span> <span class="k">try</span> <span class="nx">proxy</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@queueOfHttps</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">terminator</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@queueOfHttp</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">(),</span> <span class="nx">terminator</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">message</span><span class="p">.</span><span class="nx">red</span><span class="p">;</span> <span class="k">super</span> <span class="nx">reason</span><span class="p">,</span> <span class="kc">no</span></div></div></div></div></body></html>