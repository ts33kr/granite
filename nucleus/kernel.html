<!DOCTYPE html><html lang="en"><head><title>nucleus/kernel</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="nucleus/kernel"><meta name="groc-project-path" content="library/nucleus/kernel.coffee"><meta name="groc-github-url" content="https://github.com/ts33kr/granite"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ts33kr/granite/blob/master/library/nucleus/kernel.coffee">library/nucleus/kernel.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright (c) 2013, Alexander Cherniuk <a href="&#x6d;ai&#x6c;&#x74;&#111;:&#x74;&#x73;3&#51;&#x6b;&#114;&#x40;&#103;&#109;&#97;i&#108;&#46;&#x63;om">&#x74;&#x73;3&#51;&#x6b;&#114;&#x40;&#103;&#109;&#97;i&#108;&#46;&#x63;om</a>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div><div class="code"><div class="wrapper"><span class="nv">asciify = </span><span class="nx">require</span> <span class="s">&quot;asciify&quot;</span>
<span class="nv">connect = </span><span class="nx">require</span> <span class="s">&quot;connect&quot;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;winston&quot;</span>
<span class="nv">moment = </span><span class="nx">require</span> <span class="s">&quot;moment&quot;</span>
<span class="nv">pkginfo = </span><span class="nx">require</span> <span class="s">&quot;pkginfo&quot;</span>
<span class="nv">socketio = </span><span class="nx">require</span> <span class="s">&quot;socket.io&quot;</span>
<span class="nv">uuid = </span><span class="nx">require</span> <span class="s">&quot;node-uuid&quot;</span>
<span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&quot;assert&quot;</span>
<span class="nv">redisio = </span><span class="nx">require</span> <span class="s">&quot;redis&quot;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">nconf = </span><span class="nx">require</span> <span class="s">&quot;nconf&quot;</span>
<span class="nv">https = </span><span class="nx">require</span> <span class="s">&quot;https&quot;</span>
<span class="nv">paths = </span><span class="nx">require</span> <span class="s">&quot;path&quot;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s">&quot;fs&quot;</span>

<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;lodash&quot;</span>
<span class="nv">extendz = </span><span class="nx">require</span> <span class="s">&quot;./extends&quot;</span>
<span class="nv">compose = </span><span class="nx">require</span> <span class="s">&quot;./compose&quot;</span>
<span class="nv">bundles = </span><span class="nx">require</span> <span class="s">&quot;./bundles&quot;</span>
<span class="nv">routing = </span><span class="nx">require</span> <span class="s">&quot;./routing&quot;</span>
<span class="nv">service = </span><span class="nx">require</span> <span class="s">&quot;./service&quot;</span>
<span class="nv">scoping = </span><span class="nx">require</span> <span class="s">&quot;./scoping&quot;</span>
<span class="nv">scanner = </span><span class="nx">require</span> <span class="s">&quot;./scanner&quot;</span>
<span class="nv">plumbs = </span><span class="nx">require</span> <span class="s">&quot;./plumbs&quot;</span>

<span class="p">{</span><span class="nx">format</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="p">{</span><span class="nx">RedisStore</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;socket.io&quot;</span>
<span class="p">{</span><span class="nx">Archetype</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./arche&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a primary gateway interface for the framework. This class
provides methods and routines necessary to bootstrap the framework
and the end user application constructed within the framework. It
is both an abstract base class as well as a ready to use bootstrap.
Please refer to the documentation of the methods for more info.</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports.GraniteKernel = </span><span class="k">class</span> <span class="nx">GraniteKernel</span> <span class="k">extends</span> <span class="nx">Archetype</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This static property should contain the loaded NPM package
module which is used by the kernel to draw different kinds
of the information and data. This could be overridden by the
modified kernels that are custom to arbitrary applications.
This definition (package.json) should corellate to framework.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">assert</span> <span class="vi">@FRAMEWORK = </span><span class="nx">pkginfo</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">module</span><span class="p">).</span><span class="nx">package</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This static property should contain the loaded NPM package
module which is used by the kernel to draw different kinds
of the information and data. This could be overridden by the
modified kernels that are custom to arbitrary applications.
This definition (package.json) should corellate to application.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">assert</span> <span class="vi">@APPLICATION = </span><span class="nx">pkginfo</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">()).</span><span class="nx">package</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create a new instance of the kernel, run all the prerequisites
that are necessary, do the configuration on the kernel, then
boot it up, using the hostname and port parameters from config.
Please use this static method instead of manually launching up.
Refer to the static method <code>makeKernelSetup</code> for information.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@bootstrap: </span><span class="nf">(options={}) -&gt;</span> <span class="k">new</span> <span class="k">this</span> <span class="nx">@makeKernelSetup</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The kernel preemption routine is called once the kernel has
passed the initial launching and configuration phase, but is
yet to start up the router, connect services and instantiate
an actual application. This method gets passes continuation
that does that. The method can either invoke it or omit it.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">kernelPreemption: </span><span class="nf">(continuation) -&gt;</span> <span class="nx">continuation</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Either get or set an identica token. This token is application
identification string of a free form, but usually formed by a
app name plus a verion after the at sign. If no arguments are
supplied, the method will get identica, otherwise - attempt to
set one. If there is no identica - it asks the configuration.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@identica: </span><span class="nf">(identica) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">cns = </span><span class="s">&quot;identica:compiled&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nv">automatic = </span><span class="o">=&gt;</span> <span class="nx">f</span><span class="p">(</span><span class="nx">@$identica</span> <span class="o">or</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="nx">cns</span><span class="p">)</span>
        <span class="nv">functional = </span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">identica</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">i = </span><span class="nf">(fn) =&gt;</span> <span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span>
        <span class="nv">f = </span><span class="nf">(x) =&gt;</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">i</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="k">else</span> <span class="nx">x</span>
        <span class="k">return</span> <span class="nx">automatic</span><span class="p">()</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="vi">@$identica = </span><span class="nx">identica</span> <span class="k">if</span> <span class="nx">functional</span>
        <span class="nv">noIdentica = </span><span class="s">&quot;the identica is not a string&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">identica</span><span class="p">),</span> <span class="nx">noIdentica</span>
        <span class="nx">assert</span> <span class="vi">@$identica = </span><span class="nx">identica</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">@emit</span><span class="o">?</span> <span class="s">&quot;identica&quot;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An embedded system for adding ad-hoc configuration routines.
Supply the reasoning and the routine and this method will add
that routine to the configuration stack, to be launched once
the kernel boots up. With no arguments it returns the launcher.
This is a convenient way of running additions config routines,
when designing the derivative kernels with custom configuration.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@configure: </span><span class="nf">(explain, routine) -&gt;</span>
        <span class="p">{</span><span class="nx">series</span><span class="p">,</span> <span class="nx">apply</span><span class="p">}</span> <span class="o">=</span> <span class="nx">async</span> <span class="o">or</span> <span class="nx">require</span> <span class="s">&quot;async&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">config = </span><span class="s">&quot;Configuring: %s&quot;</span>
        <span class="nv">bareCall = </span><span class="p">(</span><span class="k">try</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nv">run = </span><span class="nx">bareCall</span> <span class="o">and</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">@$configure</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">gr = </span><span class="nf">(o) -&gt;</span> <span class="k">try</span> <span class="nx">o</span><span class="p">.</span><span class="nx">routine</span><span class="p">.</span><span class="nx">apply</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">o</span><span class="p">.</span><span class="nx">routine</span>
        <span class="nv">lg = </span><span class="nf">(o) -&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">config</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">explain</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nv">fn = </span><span class="nf">(t) -&gt;</span> <span class="nf">(o) -&gt;</span> <span class="nf">(a...) -&gt;</span> <span class="nx">lg</span> <span class="nx">o</span><span class="p">;</span> <span class="nx">gr</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">a</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">$configure = </span><span class="nx">@$configure</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">(</span><span class="nf">-&gt;</span> <span class="nx">series</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">$configure</span><span class="p">,</span> <span class="nx">fn</span> <span class="nx">@</span><span class="p">)</span> <span class="k">if</span> <span class="nx">run</span>
        <span class="k">return</span> <span class="p">(</span><span class="nf">-&gt;</span> <span class="kc">null</span><span class="p">)</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@$configure</span> <span class="o">and</span> <span class="nx">bareCall</span>
        <span class="nv">invRoutine = </span><span class="s">&quot;supplied invalid config routine&quot;</span>
        <span class="nv">invExplain = </span><span class="s">&quot;no explanation has been supplied&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">routine</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">invRoutine</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">explain</span> <span class="o">or</span> <span class="mi">0</span><span class="p">),</span> <span class="nx">invExplain</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">@$configure</span> <span class="o">?=</span> <span class="p">[]).</span><span class="nx">push</span> <span class="k">new</span> <span class="nb">Object</span>
            <span class="nv">explain: </span><span class="nx">explain</span><span class="p">,</span> <span class="nv">routine: </span><span class="nx">routine</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The complementary part of the kernel launching protocol. It is
invoked by the bootstrapping routine to do the actual kernel
launch. If you are going to override the bootstrap procedures
then override this static method, rather than the <code>bootstrap</code>.
Be careful about the relations between methods when overriding.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@makeKernelSetup: </span><span class="nf">(options) -&gt;</span> <span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="vi">@options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">cloneDeep</span> <span class="nx">options</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@options</span><span class="p">),</span> <span class="s">&quot;no options&quot;</span>
        <span class="nv">manifest = </span><span class="s">&quot;Using %s as instance identica&quot;</span>
        <span class="nv">message = </span><span class="s">&quot;Booted up framework kernel instance&quot;</span>
        <span class="nv">sigint = </span><span class="s">&quot;Received the SIGINT (interrupt signal)&quot;</span>
        <span class="nv">sigterm = </span><span class="s">&quot;Received the SIGTERM (terminate signal)&quot;</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;SIGINT&quot;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@shutdownKernel</span> <span class="nx">sigint</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;SIGTERM&quot;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@shutdownKernel</span> <span class="nx">sigterm</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@setupScaffolding</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@setupKernelBeacon</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">configure</span><span class="p">().</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="k">return</span> <span class="nx">@kernelPreemption</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(reference) =&gt;</span>
            <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@setupConnectPipeline</span><span class="p">()</span>
            <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@startupHttpsServer</span><span class="p">()</span>
            <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@startupHttpServer</span><span class="p">()</span>
            <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@setupSocketServers</span><span class="p">()</span>
            <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@setupModuleScanner</span><span class="p">()</span>
            <span class="nx">assert</span> <span class="nv">identica = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">identica</span><span class="p">()</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">manifest</span><span class="p">,</span> <span class="nx">identica</span><span class="p">.</span><span class="nx">bold</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">message</span><span class="p">.</span><span class="nx">red</span><span class="p">;</span> <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The public constructor of the kernel instrances. Generally
you should neither use it directly, not override. It serves
the purpose of setting up the configurations will never be
changed, such as the kernel self identification tokens.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">constructor: </span><span class="nf">(initializer) -&gt;</span>
        <span class="k">try</span> <span class="k">super</span> <span class="k">if</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">__super__</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="vi">@token = </span><span class="nx">uuid</span><span class="p">.</span><span class="nx">v4</span><span class="p">()</span>
        <span class="nx">nconf</span><span class="p">.</span><span class="nx">env</span><span class="p">().</span><span class="nx">argv</span><span class="p">();</span> <span class="nx">@setupLoggingFacade</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="vi">@framework = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">FRAMEWORK</span>
        <span class="nx">assert</span> <span class="vi">@application = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">APPLICATION</span>
        <span class="nx">assert</span> <span class="nv">branding = </span><span class="p">[</span><span class="nx">@framework</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s">&quot;smisome1&quot;</span><span class="p">]</span>
        <span class="nv">types = </span><span class="p">[</span><span class="nx">@framework</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="nx">@framework</span><span class="p">.</span><span class="nx">codename</span><span class="p">]</span>
        <span class="nv">GraniteKernel.instance = </span><span class="k">this</span> <span class="c1"># one kernel allowed</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">interceptExceptions</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">initializer</span>
        <span class="k">return</span> <span class="nx">asciify</span> <span class="nx">branding</span><span class="p">...,</span> <span class="nf">(error, banner) =&gt;</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="nx">banner</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">blue</span> <span class="k">unless</span> <span class="nx">error</span>
            <span class="nv">identify = </span><span class="s">&quot;Running version %s, codename: %s&quot;</span>
            <span class="nv">using = </span><span class="s">&quot;Using %s class as the kernel type&quot;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">identify</span><span class="p">.</span><span class="nx">underline</span><span class="p">,</span> <span class="nx">types</span><span class="p">...</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">using</span><span class="p">,</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">bold</span>
            <span class="nx">@domain</span><span class="p">.</span><span class="nx">run</span> <span class="o">=&gt;</span> <span class="nx">initializer</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span>
            <span class="nx">@emit</span> <span class="s">&quot;ready&quot;</span><span class="p">,</span> <span class="nx">initializer</span><span class="p">;</span> <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a little kernel registry broker that when asked to,
goes to the router registry and attempts to find there the
instance of the specified kind (class). If it succeeds then
it returns an instance to the invoker. If not, however, it
throws an assertion error about being unable to accquire.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">accquire: </span><span class="nf">(kinded, silent=no) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">ident = </span><span class="k">try</span> <span class="nx">kinded</span><span class="p">.</span><span class="nx">identify</span><span class="p">()</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">error = </span><span class="s">&quot;could not find a %s in the registry&quot;</span>
        <span class="nv">noKinded = </span><span class="s">&quot;the supplied arg has to be class&quot;</span>
        <span class="nv">success = </span><span class="s">&quot;Successfully accquired %s service&quot;</span>
        <span class="nv">formatted = </span><span class="k">try</span> <span class="nx">format</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">ident</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">registry = </span><span class="nx">@router</span><span class="o">?</span><span class="p">.</span><span class="nx">registry</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">kinded</span><span class="p">.</span><span class="nx">__super__</span><span class="p">),</span> <span class="nx">noKinded</span>
        <span class="nv">look = </span><span class="nf">(fxc) -&gt;</span> <span class="k">try</span> <span class="nx">fxc</span><span class="p">.</span><span class="nx">objectOf</span> <span class="nx">kinded</span><span class="p">,</span> <span class="kc">yes</span>
        <span class="nv">spoted = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">registry</span><span class="p">,</span> <span class="nx">look</span><span class="p">)</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">spoted</span><span class="p">)</span> <span class="o">or</span> <span class="nx">silent</span><span class="p">,</span> <span class="nx">formatted</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">success</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="k">try</span> <span class="nx">ident</span><span class="p">.</span><span class="nx">underline</span>
        <span class="k">try</span> <span class="nx">spoted</span><span class="p">.</span><span class="nx">accquired</span><span class="o">?</span> <span class="nx">kinded</span><span class="p">,</span> <span class="nx">silent</span><span class="p">;</span> <span class="nx">spoted</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This routines sets up the infrastructure necessary for kernel
to properly intercept and process errors and exceptions. This
includes synchronous exceptions as well as the asynchronous
errors. Depending on the instance configuration this method
could either crash the kernel on error or proceed operations.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">interceptExceptions: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">u = </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">crash = </span><span class="s">&quot;kernel:crashOnException&quot;</span>
        <span class="nx">assert</span> <span class="nv">skill = </span><span class="nx">@shutdownKernel</span><span class="p">.</span><span class="nx">bind</span> <span class="k">this</span>
        <span class="nx">assert</span> <span class="vi">@domain = </span><span class="nx">require</span><span class="p">(</span><span class="s">&quot;domain&quot;</span><span class="p">).</span><span class="nx">create</span><span class="p">()</span>
        <span class="nv">fatal = </span><span class="o">=&gt;</span> <span class="nx">skill</span> <span class="s">&quot;Fatal kernel error at U=</span><span class="si">#{</span><span class="nx">u</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">str = </span><span class="nf">(err) -&gt;</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span> <span class="o">or</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">or</span> <span class="nx">err</span>
        <span class="nx">@</span><span class="kc">on</span> <span class="s">&quot;panic&quot;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span> <span class="nx">bark</span><span class="p">,</span> <span class="nx">str</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
        <span class="nx">@</span><span class="kc">on</span> <span class="s">&quot;panic&quot;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span> <span class="nx">fatal</span><span class="p">()</span> <span class="k">if</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="nx">crash</span>
        <span class="nx">@domain</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="nf">(err) =&gt;</span> <span class="nx">@emit</span> <span class="s">&quot;panic&quot;</span><span class="p">,</span> <span class="nx">err</span>
        <span class="nv">bark = </span><span class="s">&quot;Kernel domain panic at U=</span><span class="si">#{</span><span class="nx">u</span><span class="si">}</span><span class="s">\r\n%s&quot;</span><span class="p">.</span><span class="nx">red</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">removeAllListeners</span> <span class="s">&quot;uncaughtException&quot;</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;uncaughtException&quot;</span><span class="p">,</span> <span class="nf">(error, arg) =&gt;</span>
            <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">str</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">is</span> <span class="s">&quot;socket end&quot;</span>
            <span class="k">return</span> <span class="nx">@emit</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="s">&quot;panic&quot;</span><span class="p">,</span> <span class="nx">error</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Shutdown the kernel instance. This includes shutting down both
HTTP and HTTPS server that may be running, stopping the router
and unregistering all the services as a precauting. After that
the scope is being dispersed and some events are being emited.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">shutdownKernel: </span><span class="nf">(reason, eol=yes) -&gt;</span>
        <span class="nv">g = </span><span class="s">&quot;Kernel has requested to be shutted down&quot;</span>
        <span class="nx">util</span><span class="p">.</span><span class="nx">puts</span> <span class="nx">require</span><span class="p">(</span><span class="s">&quot;os&quot;</span><span class="p">).</span><span class="nx">EOL</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="k">if</span> <span class="nx">eol</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="p">(</span><span class="nx">reason</span> <span class="o">or</span> <span class="nx">g</span> <span class="o">or</span> <span class="mi">0</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">red</span>
        <span class="k">try</span> <span class="nx">@router</span><span class="p">.</span><span class="nx">shutdownRouter</span><span class="o">?</span><span class="p">()</span> <span class="k">catch</span> <span class="nx">error</span> <span class="k">then</span>
        <span class="nv">snapshot = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">@router</span><span class="o">?</span><span class="p">.</span><span class="nx">registry</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">unreg = </span><span class="nx">@router</span><span class="p">.</span><span class="nx">unregister</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@router</span>
        <span class="nv">xkill = </span><span class="nf">(s, next) -&gt;</span> <span class="k">return</span> <span class="nx">unreg</span> <span class="nx">s</span><span class="p">,</span> <span class="p">(</span><span class="nf">-&gt;</span> <span class="nx">next</span><span class="p">())</span>
        <span class="nv">fns = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">snapshot</span><span class="p">,</span> <span class="nf">(s) -&gt;</span> <span class="nf">(n) -&gt;</span> <span class="nx">xkill</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">n</span>
        <span class="k">return</span> <span class="nx">async</span><span class="p">.</span><span class="nx">series</span> <span class="nx">fns</span><span class="p">,</span> <span class="nf">(error, results) =&gt;</span>
            <span class="k">try</span> <span class="nx">@server</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span> <span class="k">try</span> <span class="nx">@secure</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
            <span class="k">try</span> <span class="nx">@secureSocket</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@secureSocket</span><span class="o">?</span>
            <span class="k">try</span> <span class="nx">@serverSocket</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@serverSocket</span><span class="o">?</span>
            <span class="nv">shutdown = </span><span class="s">&quot;Shutting the kernel instance down&quot;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">red</span><span class="p">;</span> <span class="k">this</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;shutdown&quot;</span>
            <span class="nx">@scope</span><span class="o">?</span><span class="p">.</span><span class="nx">disintegrate</span><span class="p">();</span> <span class="nx">@domain</span><span class="o">?</span><span class="p">.</span><span class="nx">dispose</span><span class="p">()</span>
            <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="o">-</span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The important internal routine that sets up and configures a
kernel beacon that gets fired once at each configured interval.
The beacon, once fired, gets propagated to all services that
implement the appropriate asynchronous hook. This mechanism is
intended as a heartbeat that can be leveraged by each service.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupKernelBeacon: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nv">u = </span><span class="nf">-&gt;</span> <span class="k">try</span> <span class="nx">moment</span><span class="p">.</span><span class="nx">unix</span><span class="p">()</span>
        <span class="nv">msg = </span><span class="s">&quot;Setting up the kernel beacon at %s ms&quot;</span>
        <span class="nv">interval = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;beacon:interval&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">noInterval = </span><span class="s">&quot;no beacon interval has been given&quot;</span>
        <span class="nv">eua = </span><span class="nf">(s) =&gt;</span> <span class="nf">(n) =&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">downstream</span><span class="p">(</span><span class="nv">beacon: </span><span class="nx">n</span><span class="p">)(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">u</span><span class="p">())</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">interval</span><span class="p">),</span> <span class="nx">noInterval</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">magenta</span><span class="p">,</span> <span class="nx">interval</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">bold</span>
        <span class="nv">timer = </span><span class="nf">(millisec, fn) -&gt;</span> <span class="nx">setInterval</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">millisec</span>
        <span class="k">return</span> <span class="vi">@beacon = </span><span class="nx">timer</span> <span class="nx">interval</span><span class="p">,</span> <span class="nf">(parameters) =&gt;</span>
            <span class="nx">assert</span> <span class="nv">unix = </span><span class="nx">moment</span><span class="p">().</span><span class="nx">unix</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
            <span class="nv">pulse = </span><span class="s">&quot;Kernel beacon pulse at a %s UNIX&quot;</span>
            <span class="nx">assert</span> <span class="nv">services = </span><span class="nx">@router</span><span class="p">.</span><span class="nx">registry</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">pulse</span><span class="p">.</span><span class="nx">magenta</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">unix</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">bold</span>
            <span class="nv">prepared = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">services</span><span class="p">,</span> <span class="nx">eua</span><span class="p">)</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
            <span class="nx">async</span><span class="p">.</span><span class="nx">series</span> <span class="nx">prepared</span><span class="p">,</span> <span class="nf">(err, res) -&gt;</span> <span class="kc">null</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Allocate a module scanner insrance for this kernel and setup
the scanner per the scoping configuration to monitor certain
directories. Please reference the <code>ModuleScanner</code> comppnent
implementation for more information on its operations and a
configuration routines and facilities. The scanner itself is
is a zombie services, therefore is instantuated accordingly.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupModuleScanner: </span><span class="nf">-&gt;</span>
        <span class="nv">makeFailed = </span><span class="s">&quot;failed to make module scanner&quot;</span>
        <span class="nv">message = </span><span class="s">&quot;Allocate %s service as dir monitor&quot;</span>
        <span class="vi">@scanner = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">ModuleScanner</span><span class="p">.</span><span class="nx">obtain</span> <span class="k">this</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">scanner</span> <span class="o">or</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">makeFailed</span>
        <span class="nv">identify = </span><span class="nx">@scanner</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">bold</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">message</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="nx">identify</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nv">configs = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;layout:config&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">subjects = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;scanner:dirs&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">library = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;layout:library&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">subjects</span><span class="p">),</span> <span class="s">&quot;scanner not configed&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">configs</span><span class="p">),</span> <span class="s">&quot;no configure layout&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">library</span><span class="p">),</span> <span class="s">&quot;no library layouts&quot;</span>
        <span class="nv">monitor = </span><span class="nx">@scanner</span><span class="p">.</span><span class="nx">monitorDirectory</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@scanner</span>
        <span class="nx">monitor</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&quot;../exposure&quot;</span>
        <span class="nx">monitor</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">__dirname</span><span class="p">,</span> <span class="s">&quot;../semantic&quot;</span>
        <span class="nx">monitor</span> <span class="nx">directory</span> <span class="k">for</span> <span class="nx">directory</span> <span class="k">in</span> <span class="nx">subjects</span>
        <span class="nx">monitor</span> <span class="nx">library</span><span class="p">;</span> <span class="nx">monitor</span> <span class="nx">configs</span><span class="p">;</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The utilitary method that is being called by either the kernel
or scope implementation to establish the desirable facade for
logging. The options from the config may be used to configure
various options of the logger, such as output format, etc.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupLoggingFacade: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="vi">@logging = </span><span class="nx">logger</span>
        <span class="nx">assert</span> <span class="nv">format = </span><span class="s">&quot;DD/MM/YYYY @ HH:mm:ss&quot;</span>
        <span class="nv">stamp = </span><span class="nf">-&gt;</span> <span class="k">return</span> <span class="nx">moment</span><span class="p">().</span><span class="nx">format</span> <span class="nx">format</span>
        <span class="nv">options = timestamp: </span><span class="nx">stamp</span><span class="p">,</span> <span class="nv">colorize: </span><span class="kc">yes</span>
        <span class="nv">options.level = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;log:level&quot;</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">noLevel = </span><span class="s">&quot;No logging level is specified&quot;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="nx">noLevel</span> <span class="k">unless</span> <span class="nx">options</span><span class="p">.</span><span class="nx">level</span>
        <span class="nx">assert</span> <span class="nv">console = </span><span class="nx">logger</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">Console</span>
        <span class="k">try</span> <span class="nx">do</span> <span class="nf">-&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">console</span> <span class="k">catch</span> <span class="nx">error</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">add</span> <span class="nx">console</span><span class="p">,</span> <span class="nx">options</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This routine takes care of resolving all the necessary details
for successfully creating and running an HTTPS (SSL) server.
The details are typically at least the key and the certficiate.
This implementation draws data from the config file and then
used it to obtain the necessary content and whater else needs.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">resolveSslDetails: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">secure = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;secure&quot;</span><span class="p">;</span> <span class="nv">options = </span><span class="p">{}</span>
        <span class="nv">key = </span><span class="nx">paths</span><span class="p">.</span><span class="nx">relative</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="nx">secure</span><span class="p">.</span><span class="nx">key</span>
        <span class="nv">cert = </span><span class="nx">paths</span><span class="p">.</span><span class="nx">relative</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="nx">secure</span><span class="p">.</span><span class="nx">cert</span>
        <span class="nv">template = </span><span class="s">&quot;Reading SSL %s file at %s&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">template</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="s">&quot;key&quot;</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">underline</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">template</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="s">&quot;cert&quot;</span><span class="p">.</span><span class="nx">bold</span><span class="p">,</span> <span class="nx">cert</span><span class="p">.</span><span class="nx">underline</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;Assembling the HTTPS options&quot;</span><span class="p">.</span><span class="nx">grey</span>
        <span class="nv">options.key = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">key</span>
        <span class="nv">options.cert = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">cert</span>
        <span class="nx">assert</span> <span class="nx">options</span><span class="p">.</span><span class="nx">cert</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;invalid SSL cert&quot;</span>
        <span class="nx">assert</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;invalid SSL key&quot;</span>
        <span class="nv">options.secure = </span><span class="nx">secure</span><span class="p">;</span> <span class="k">return</span> <span class="nb">Object</span> <span class="nx">options</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup and launch either HTTP or HTTPS servers to listen at
the configured addresses and ports. This method reads up the
scoping configuration in order to obtain the data necessary
for instantiating, configuring and launching up the servers.
See the method implementation for info on the exact semantic.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startupHttpsServer: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">server = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;server&quot;</span> <span class="o">or</span> <span class="p">{}</span>
        <span class="nx">assert</span> <span class="nv">hostname = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;server:host&quot;</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">https</span><span class="p">),</span> <span class="s">&quot;no HTTPS port&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">options = </span><span class="nx">@resolveSslDetails</span><span class="p">()</span>
        <span class="nv">running = </span><span class="s">&quot;Running HTTPS server at %s&quot;</span><span class="p">.</span><span class="nx">magenta</span>
        <span class="nv">arrived = </span><span class="s">&quot;Incoming </span><span class="si">#{</span><span class="s">&quot;HTTPS&quot;</span><span class="p">.</span><span class="nx">bold</span><span class="si">}</span><span class="s"> connection at %s&quot;</span>
        <span class="nv">location = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">hostname</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">server</span><span class="p">.</span><span class="nx">https</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">running</span><span class="p">.</span><span class="nx">underline</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">underline</span>
        <span class="vi">@secure = </span><span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">@connect</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">@domain</span><span class="p">;</span> <span class="nx">@domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@secure</span>
        <span class="nx">do</span> <span class="o">=&gt;</span> <span class="nx">@secure</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">server</span><span class="p">.</span><span class="nx">https</span><span class="p">,</span> <span class="nx">hostname</span>
        <span class="k">return</span> <span class="nx">@secure</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;connection&quot;</span><span class="p">,</span> <span class="nf">(socket) -&gt;</span>
            <span class="nv">key = </span><span class="nx">socket</span><span class="p">.</span><span class="nx">server</span><span class="o">?</span><span class="p">.</span><span class="nx">_connectionKey</span>
            <span class="nv">key = </span><span class="k">try</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">underline</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">arrived</span><span class="p">.</span><span class="nx">green</span><span class="p">,</span> <span class="nx">key</span>
            <span class="k">return</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">setNoDelay</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup and launch either HTTP or HTTPS servers to listen at
the configured addresses and ports. This method reads up the
scoping configuration in order to obtain the data necessary
for instantiating, configuring and launching up the servers.
See the method implementation for info on the exact semantic.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">startupHttpServer: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="nv">server = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;server&quot;</span> <span class="o">or</span> <span class="p">{}</span>
        <span class="nx">assert</span> <span class="nv">hostname = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;server:host&quot;</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">http</span><span class="p">),</span> <span class="s">&quot;no HTTP port&quot;</span>
        <span class="nv">running = </span><span class="s">&quot;Running HTTP server at %s&quot;</span><span class="p">.</span><span class="nx">magenta</span>
        <span class="nv">arrived = </span><span class="s">&quot;Incoming </span><span class="si">#{</span><span class="s">&quot;HTTP&quot;</span><span class="p">.</span><span class="nx">bold</span><span class="si">}</span><span class="s"> connection at %s&quot;</span>
        <span class="nv">location = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">hostname</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">server</span><span class="p">.</span><span class="nx">http</span><span class="si">}</span><span class="s">&quot;</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">running</span><span class="p">.</span><span class="nx">underline</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">underline</span>
        <span class="vi">@server = </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span> <span class="nx">@connect</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">@domain</span><span class="p">;</span> <span class="nx">@domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@server</span>
        <span class="nx">do</span> <span class="o">=&gt;</span> <span class="nx">@server</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">server</span><span class="p">.</span><span class="nx">http</span><span class="p">,</span> <span class="nx">hostname</span>
        <span class="k">return</span> <span class="nx">@server</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;connection&quot;</span><span class="p">,</span> <span class="nf">(socket) -&gt;</span>
            <span class="nv">key = </span><span class="nx">socket</span><span class="p">.</span><span class="nx">server</span><span class="o">?</span><span class="p">.</span><span class="nx">_connectionKey</span>
            <span class="nv">key = </span><span class="k">try</span> <span class="nx">key</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">underline</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">arrived</span><span class="p">.</span><span class="nx">green</span><span class="p">,</span> <span class="nx">key</span>
            <span class="k">return</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">setNoDelay</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup and attach Socket.IO handlers to each of the servers.
That is HTTP and HTTPS servers that are running and listening
for new connections. The kernel itself does not use the sockets
it just sets it up. Please refer to the Socket.IO docs for info.
Also, see the <code>configureSocketServers</code> method implementation.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupSocketServers: </span><span class="nf">-&gt;</span>
        <span class="nv">killed = </span><span class="s">&quot;Killed %s as orphaned socket&quot;</span><span class="p">.</span><span class="nx">red</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">sconfig = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;socket&quot;</span>
        <span class="nx">assert</span> <span class="nv">txf = </span><span class="nf">(fn) -&gt;</span> <span class="k">return</span> <span class="nx">setTimeout</span> <span class="nx">fn</span><span class="p">,</span> <span class="mi">1000</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Attaching Socket.IO to HTTPS server&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Attaching Socket.IO to HTTP server&quot;</span>
        <span class="nv">newMessage = </span><span class="s">&quot;New Socket.IO connected at %s server&quot;</span>
        <span class="nv">k = </span><span class="nf">(so) -&gt;</span> <span class="nx">so</span><span class="p">.</span><span class="nx">disconnect</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;killed orphan&quot;</span>
        <span class="nv">logging = </span><span class="nf">(st) -&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">newMessage</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">st</span>
        <span class="nv">defects = </span><span class="nf">(so) -&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">killed</span><span class="p">,</span> <span class="nx">so</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">bold</span>
        <span class="nv">discont = </span><span class="nf">(so) -&gt;</span> <span class="nx">so</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;orphan&quot;</span><span class="p">;</span> <span class="nx">defects</span> <span class="nx">so</span><span class="p">;</span> <span class="nx">k</span> <span class="nx">so</span>
        <span class="nv">timeout = </span><span class="nf">(so) -&gt;</span> <span class="nf">-&gt;</span> <span class="k">try</span> <span class="nx">discont</span> <span class="nx">so</span> <span class="k">unless</span> <span class="nx">so</span><span class="p">.</span><span class="nx">owned</span>
        <span class="nv">newSock = </span><span class="nf">(st) -&gt;</span> <span class="nf">(so) -&gt;</span> <span class="nx">logging</span> <span class="nx">st</span><span class="p">;</span> <span class="nx">txf</span> <span class="nx">timeout</span><span class="p">(</span><span class="nx">so</span><span class="p">)</span>
        <span class="nx">assert</span> <span class="vi">@secureSocket = </span><span class="nx">socketio</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">@secure</span><span class="p">,</span> <span class="nx">sconfig</span>
        <span class="nx">assert</span> <span class="vi">@serverSocket = </span><span class="nx">socketio</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">@server</span><span class="p">,</span> <span class="nx">sconfig</span>
        <span class="nx">@configureSocketServers</span> <span class="nx">@serverSocket</span><span class="p">,</span> <span class="nx">@secureSocket</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">secureSocket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;connection&quot;</span><span class="p">,</span> <span class="nx">newSock</span> <span class="s">&quot;HTTPS&quot;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">serverSocket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;connection&quot;</span><span class="p">,</span> <span class="nx">newSock</span> <span class="s">&quot;HTTP&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This configuration utility sets up the environment for the
Socket.IO server in the current kernel. Basically, this does
the socket server configuration using the Socket.IO configure
API to set the necessary options to opimize the performance.
Please refer to the implementation for more info on options.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">configureSocketServers: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nv">servers = </span><span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span> <span class="nx">arguments</span>
        <span class="nx">@domain</span><span class="p">.</span><span class="nx">add</span> <span class="nx">server</span> <span class="k">for</span> <span class="k">own</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">index</span> <span class="k">of</span> <span class="nx">servers</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Configuring the Socket.IO servers&quot;</span><span class="p">.</span><span class="nx">cyan</span>
        <span class="nx">assert</span> <span class="nx">@serverSocket</span> <span class="k">in</span> <span class="nx">servers</span><span class="p">,</span> <span class="s">&quot;missing HTTP socket&quot;</span>
        <span class="nx">assert</span> <span class="nx">@secureSocket</span> <span class="k">in</span> <span class="nx">servers</span><span class="p">,</span> <span class="s">&quot;missing HTTPS socket&quot;</span>
        <span class="k">return</span> <span class="nx">@</span><span class="kc">on</span> <span class="s">&quot;redis-ready&quot;</span><span class="p">,</span> <span class="nf">(redis) =&gt;</span> <span class="nx">do</span> <span class="nf">(redis) =&gt;</span>
            <span class="nv">message = </span><span class="s">&quot;Attaching Redis storage to sockets&quot;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">cyan</span> <span class="k">if</span> <span class="nx">logger</span>
            <span class="nx">assert</span> <span class="nv">readapter = </span><span class="nx">require</span> <span class="s">&quot;socket.io-redis&quot;</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nv">port = </span><span class="k">try</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">port</span> <span class="o">or</span> <span class="kc">null</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nv">host = </span><span class="k">try</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">host</span> <span class="o">or</span> <span class="kc">null</span>
            <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nv">opts = </span><span class="k">try</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">options</span> <span class="o">or</span> <span class="mi">0</span>
            <span class="nv">pubCon = </span><span class="nx">redisio</span><span class="p">.</span><span class="nx">createClient</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">opts</span>
            <span class="nv">subCon = </span><span class="nx">redisio</span><span class="p">.</span><span class="nx">createClient</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">opts</span>
            <span class="nv">ready = pubClient: </span><span class="nx">pubCon</span><span class="p">,</span> <span class="nv">subClient: </span><span class="nx">subCon</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">secureSocket</span><span class="p">.</span><span class="nx">adapter</span> <span class="nx">readapter</span> <span class="nx">ready</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">serverSocket</span><span class="p">.</span><span class="nx">adapter</span> <span class="nx">readapter</span> <span class="nx">ready</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup the Connect middleware framework along with the default
pipeline of middlewares necessary for the Granite framework to
operate correctly. You are encouraged to override this method
to provide a Connect setup procedure to your own liking, etc.
Each middleware instance is stored in the kernel as variable.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupConnectPipeline: </span><span class="nf">-&gt;</span>
        <span class="nx">assert</span> <span class="vi">@connect = </span><span class="nx">connect</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nx">@connectStaticAssets</span><span class="p">()</span>
        <span class="nv">threshold = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">threshold</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@threshold = </span><span class="nx">threshold</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@query = </span><span class="nx">connect</span><span class="p">.</span><span class="nx">query</span><span class="p">()</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@compress = </span><span class="nx">connect</span><span class="p">.</span><span class="nx">compress</span><span class="p">()</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@bodyParser = </span><span class="nx">connect</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@cookieParser = </span><span class="nx">connect</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">()</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@parameters = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">parameters</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@extSession = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">extSession</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@negotiate = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">negotiate</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@platform = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">platform</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@redirect = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">redirect</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@session = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">session</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@accepts = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">accepts</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@logger = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">logger</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="vi">@send = </span><span class="nx">plumbs</span><span class="p">.</span><span class="nx">send</span> <span class="k">this</span>
        <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="nx">@middleware</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Setup a set of appropriate Connect middlewares that will take
care of serving static directory content for all configured
assets directory, using the options drawed from configuration.
You should override the method to tweak the creation process.
Please see the <code>serveStaticDirectory</code> method implementation.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">connectStaticAssets: </span><span class="nf">-&gt;</span>
        <span class="nv">envs = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;env:dirs&quot;</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nv">dirs = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;assets:dirs&quot;</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nv">opts = </span><span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;assets:opts&quot;</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="nv">pub = </span><span class="nf">-&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">envs</span><span class="p">,</span> <span class="nf">(dir) -&gt;</span> <span class="nx">dir</span> <span class="o">is</span> <span class="s">&quot;pub&quot;</span>
        <span class="nv">established = </span><span class="k">try</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">__dirname</span><span class="si">}</span><span class="s">/../../public&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">pub</span><span class="p">()),</span> <span class="s">&quot;no pub environment&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">opts</span><span class="p">),</span> <span class="s">&quot;wrong assets options&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">dirs</span><span class="p">),</span> <span class="s">&quot;no assets directories&quot;</span>
        <span class="nx">@serveStaticDirectory</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">opts</span> <span class="k">for</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">dirs</span>
        <span class="nx">@serveStaticDirectory</span> <span class="nx">established</span><span class="p">,</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="nx">@serveStaticDirectory</span> <span class="nx">pub</span><span class="p">();</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Create and wire in an appropriate Connext middleware that will
serve the specified directory as the directory with a static
content. That is, it will expose it to the world (not list it).
The serving aspects can be configured via a passed in options.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">serveStaticDirectory: </span><span class="nf">(directory, options={}) -&gt;</span>
        <span class="nx">assert</span> <span class="nv">cwd = </span><span class="k">try</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">().</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nv">solved = </span><span class="k">try</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">relative</span> <span class="nx">cwd</span><span class="p">,</span> <span class="nx">directory</span>
        <span class="nv">serving = </span><span class="s">&quot;Serving %s as static assets dir&quot;</span>
        <span class="nv">notExist = </span><span class="s">&quot;The assets dir %s does not exist&quot;</span>
        <span class="nv">fail = </span><span class="nf">-&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">notExist</span><span class="p">,</span> <span class="nx">solved</span><span class="p">.</span><span class="nx">underline</span>
        <span class="k">return</span> <span class="nx">fail</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">directory</span>
        <span class="nv">middleware = </span><span class="nx">connect</span><span class="p">.</span><span class="nx">static</span> <span class="nx">directory</span><span class="p">,</span> <span class="nx">options</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span> <span class="nx">serving</span><span class="p">.</span><span class="nx">cyan</span><span class="p">,</span> <span class="nx">solved</span><span class="p">.</span><span class="nx">underline</span>
        <span class="k">try</span> <span class="nx">@connect</span><span class="p">.</span><span class="nx">use</span> <span class="nx">middleware</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This method sets up the necessary internal toolkits, such as
the determined scope and the router, which is then are wired
in with the located and instantiated services. Please refer
to the implementation on how and what is being done exactly.
Also, it looks up and initialized the requested env scope.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">setupScaffolding: </span><span class="nf">-&gt;</span>
        <span class="nv">tag = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;NODE_ENV&quot;</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nv">mode = </span><span class="k">try</span> <span class="nx">nconf</span><span class="p">.</span><span class="nx">get</span> <span class="s">&quot;forever&quot;</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nv">missing = </span><span class="s">&quot;no valid NODE_ENV variable found&quot;</span>
        <span class="nv">mode = </span><span class="nx">mode</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">().</span><span class="nx">underline</span> <span class="k">if</span> <span class="nx">mode</span>
        <span class="nv">bare = </span><span class="s">&quot;Running without Forever supervision&quot;</span>
        <span class="nv">supd = </span><span class="s">&quot;Running using %s mode within Forever&quot;</span>
        <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">tag</span><span class="p">),</span> <span class="nx">missing</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="vi">@tag = @env = @environment = </span><span class="nx">tag</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nx">assert</span> <span class="vi">@scope = </span><span class="k">try</span> <span class="nx">scoping</span><span class="p">.</span><span class="nx">Scope</span><span class="p">.</span><span class="nx">lookup</span> <span class="nx">tag</span>
        <span class="nx">assert</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">incorporate</span> <span class="k">this</span><span class="p">,</span> <span class="kc">undefined</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">bare</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">red</span> <span class="k">unless</span> <span class="nx">mode</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="nx">supd</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">red</span><span class="p">,</span> <span class="nx">mode</span> <span class="k">if</span> <span class="nx">mode</span>
        <span class="nx">assert</span> <span class="vi">@router = </span><span class="k">new</span> <span class="nx">routing</span><span class="p">.</span><span class="nx">ServiceRouter</span> <span class="nx">@</span>
        <span class="nx">assert</span> <span class="vi">@middleware = </span><span class="nx">@router</span><span class="p">.</span><span class="nx">middleware</span>
        <span class="vi">@middleware = </span><span class="nx">@middleware</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@router</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">@middleware</span><span class="p">;</span> <span class="k">this</span></div></div></div></div></body></html>