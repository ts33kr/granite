<!DOCTYPE html><html lang="en"><head><title>nucleus/restful</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="nucleus/restful"><meta name="groc-project-path" content="library/nucleus/restful.coffee"><meta name="groc-github-url" content="https://github.com/ts33kr/granite"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/ts33kr/granite/blob/master/library/nucleus/restful.coffee">library/nucleus/restful.coffee</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><p>Copyright (c) 2013, Alexander Cherniuk <a href="&#x6d;&#x61;&#105;&#x6c;&#x74;&#x6f;:&#116;&#x73;&#51;&#x33;&#107;&#114;&#x40;&#x67;m&#x61;&#105;&#x6c;.&#x63;&#111;&#109;">&#116;&#x73;&#51;&#x33;&#107;&#114;&#x40;&#x67;m&#x61;&#105;&#x6c;.&#x63;&#111;&#109;</a>
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:</p>

<ol>
<li>Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.</li>
<li>Redistributions in binary form must reproduce the above copyright notice,
this list of conditions and the following disclaimer in the documentation
and/or other materials provided with the distribution.</li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p></div></div><div class="code"><div class="wrapper"><span class="nv">url = </span><span class="nx">require</span> <span class="s">&quot;url&quot;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&quot;util&quot;</span>
<span class="nv">weak = </span><span class="nx">require</span> <span class="s">&quot;weak&quot;</span>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&quot;async&quot;</span>
<span class="nv">assert = </span><span class="nx">require</span> <span class="s">&quot;assert&quot;</span>
<span class="nv">colors = </span><span class="nx">require</span> <span class="s">&quot;colors&quot;</span>
<span class="nv">logger = </span><span class="nx">require</span> <span class="s">&quot;winston&quot;</span>

<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&quot;lodash&quot;</span>
<span class="nv">tools = </span><span class="nx">require</span> <span class="s">&quot;./toolkit&quot;</span>
<span class="nv">extendz = </span><span class="nx">require</span> <span class="s">&quot;./extends&quot;</span>
<span class="nv">routing = </span><span class="nx">require</span> <span class="s">&quot;./routing&quot;</span>
<span class="p">{</span><span class="nx">STATUS_CODES</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;http&quot;</span>
<span class="p">{</span><span class="nx">Service</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;./service&quot;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is an abstract base class for every service in the system
and in the end user application that provides a REST interface
to some arbitrary resource, determined by HTTP path and guarded
by the domain matching. This is the crucial piece of framework.
It supports strictly methods defined in the HTTP specification,
yet providing a tiny enough structure to be able to override it.</p></div></div><div class="code"><div class="wrapper"><span class="nv">module.exports.RestfulService = </span><span class="k">class</span> <span class="nx">RestfulService</span> <span class="k">extends</span> <span class="nx">Service</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is a marker that indicates to some internal subsystems
that this class has to be considered abstract and therefore
can not be treated as a complete class implementation. This
mainly is used to exclude or account for abstract classes.
Once inherited from, the inheritee is not abstract anymore.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@abstract</span> <span class="kc">yes</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An array of HTTP methods (also called verbs) supported by the
this abstract base class. The array of methods is strictly
limited by the HTTP specification by default. You can though
override it and provie support for more methods, up to you.
If you do, then be sure to provide the necessary stubbing.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@SUPPORTED = </span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;PUT&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">,</span> <span class="s">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="s">&quot;PATCH&quot;</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Symbol declaration table, that states what keys, if those are
vectors (arrays) should be exported and then merged with their
counterparts in the destination, once the composition process
takes place. See the <code>Archetype::composition</code> hook definition
for more information. Keys are names, values can be anything.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@COMPOSITION_EXPORTS = </span><span class="nv">conditions: </span><span class="mi">1</span><span class="p">,</span> <span class="nv">middlewares: </span><span class="mi">1</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Impose a conditional limitation on the service. The limiation
will be invoked when a router is determining whether a service
matches the condition or not. The limitation has to either do
accept or decline. Do this by calling <code>decide</code> with a boolean!
Especially useful for service with the same resource but with
different conditions, such as mobile only and desktop only.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@condition: </span><span class="nf">(synopsis, limitation) -&gt;</span>
        <span class="k">return</span> <span class="k">try</span> <span class="nx">@conditions</span> <span class="k">if</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nv">limitation = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span>
        <span class="nv">generic = </span><span class="s">&quot;service condition: </span><span class="si">#{</span><span class="nx">limitation</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">try</span> <span class="nv">synopsis = </span><span class="nx">generic</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">synopsis</span>
        <span class="nv">noLimitation = </span><span class="s">&quot;a limitation has to be function&quot;</span>
        <span class="nv">wrongSignature = </span><span class="s">&quot;malformed limitation signature&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">synopsis</span><span class="p">),</span> <span class="s">&quot;got no synopsis&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">limitation</span><span class="p">),</span> <span class="nx">noLimitation</span>
        <span class="nx">assert</span> <span class="nx">limitation</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">wrongSignature</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">inherited = </span><span class="nx">@conditions</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="nv">fn = </span><span class="nf">(arbitraryVector) -&gt;</span> <span class="k">return</span> <span class="nx">implement</span>
        <span class="nx">assert</span> <span class="nv">inherited = </span><span class="k">try</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span> <span class="nx">inherited</span>
        <span class="k">return</span> <span class="nx">fn</span> <span class="vi">@conditions = </span><span class="nx">inherited</span><span class="p">.</span><span class="nx">concat</span>
            <span class="nv">limitation: </span><span class="nx">limitation</span> <span class="c1"># a function</span>
            <span class="nv">synopsis: </span><span class="nx">synopsis</span> <span class="c1"># an explanation</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This method is almost an entire implementation of a middleware
system for services. When you call it from within the service
definition with a function - it install it as middleware. But
When you invoke it without arguments, it assembled and returns
the executor that spins up all the middlewares. Please refer
to the <code>process</code> method implementation to get a usage example.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@middleware: </span><span class="nf">(implement) -&gt;</span>
        <span class="nv">seq = </span><span class="nf">-&gt;</span> <span class="nx">log</span><span class="p">();</span> <span class="nx">async</span><span class="p">.</span><span class="nx">series</span> <span class="nx">arguments</span><span class="p">...</span>
        <span class="nv">log = </span><span class="nf">-&gt;</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">message</span><span class="p">.</span><span class="nx">yellow</span><span class="p">,</span> <span class="nx">idc</span>
        <span class="nv">idc = </span><span class="k">this</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">toString</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">m = </span><span class="nx">@middlewares</span> <span class="o">or</span> <span class="nb">Array</span><span class="p">()</span>
        <span class="nv">message = </span><span class="s">&quot;Running middleware sequence for %s&quot;</span>
        <span class="nv">a = </span><span class="nf">(fun, t, s, n) -&gt;</span> <span class="nx">fun</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
        <span class="nv">f = </span><span class="nf">(s) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">m</span><span class="p">,</span> <span class="nf">(b) =&gt;</span> <span class="nf">(n) =&gt;</span> <span class="nx">a</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
        <span class="nv">executor = </span><span class="nf">(s) -&gt;</span> <span class="nf">(c) =&gt;</span> <span class="nx">seq</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">s</span><span class="p">),</span> <span class="nx">c</span>
        <span class="k">return</span> <span class="nx">executor</span> <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">is</span> <span class="mi">0</span>
        <span class="nv">noImplement = </span><span class="s">&quot;supply the middleware function&quot;</span>
        <span class="nv">wrongSignature = </span><span class="s">&quot;a wrong implement signature&quot;</span>
        <span class="k">try</span> <span class="nv">implement = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">implement</span><span class="p">),</span> <span class="nx">noImplement</span>
        <span class="nx">assert</span> <span class="nx">implement</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">wrongSignature</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nv">inherited = </span><span class="nx">@middlewares</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="vi">@middlewares = </span><span class="nx">inherited</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">implement</span>
        <span class="vi">@middlewares = </span><span class="nx">_</span><span class="p">.</span><span class="nx">unique</span> <span class="nx">@middlewares</span><span class="p">;</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An experimental spinoff engine that is based on the isolated
providers concept. Basically, an HTTP verb or the middleware
that is decorated with this method will be isolated to be run
under the shadow of the real service instance. The process is
idempotent. Please refer to the implementation of this method
and to the implementation of the <code>DuplexCore</code> for information.</p></div></div><div class="code"><div class="wrapper">    <span class="vi">@spinoff: </span><span class="nf">(implement) -&gt;</span> <span class="nf">(request, response, signed) -&gt;</span>
        <span class="nv">noImplement = </span><span class="s">&quot;no valid implementation body&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">implement</span><span class="p">),</span> <span class="nx">noImplement</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArguments</span> <span class="nv">capture = </span><span class="nx">arguments</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">m = </span><span class="s">&quot;Spinned off incoming HTTP request at %s&quot;</span>
        <span class="nv">shadow = </span><span class="nx">request</span><span class="p">.</span><span class="nx">shadow</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span> <span class="k">this</span>
        <span class="nv">execute = </span><span class="nf">-&gt;</span> <span class="nx">implement</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nx">capture</span>
        <span class="k">return</span> <span class="nx">execute</span><span class="p">()</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">request</span><span class="p">.</span><span class="nx">shadow</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="k">try</span> <span class="nv">request.shadow = </span><span class="nx">shadow</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nv">__isolated: </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">__origin: </span><span class="nx">@</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nv">response: </span><span class="k">try</span> <span class="nx">weak</span> <span class="nx">response</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nv">request: </span><span class="k">try</span> <span class="nx">weak</span> <span class="nx">request</span>
        <span class="nv">s = get: </span><span class="nf">-&gt;</span> <span class="k">try</span> <span class="nx">request</span><span class="p">.</span><span class="nx">session</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="nv">e = get: </span><span class="nf">-&gt;</span> <span class="k">try</span> <span class="nx">request</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">or</span> <span class="kc">undefined</span>
        <span class="p">{</span><span class="nx">AccessGate</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&quot;../exposure/access&quot;</span>
        <span class="nv">symbol = </span><span class="k">try</span> <span class="nx">AccessGate</span><span class="p">.</span><span class="nx">ACCESS_ENTITY_SYMBOL</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">m</span><span class="p">.</span><span class="nx">grey</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span><span class="p">.</span><span class="nx">underline</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">shadow</span><span class="p">,</span> <span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="nx">s</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span> <span class="nx">shadow</span><span class="p">,</span> <span class="nx">symbol</span><span class="p">,</span> <span class="nx">e</span>
        <span class="nx">@emit</span> <span class="s">&quot;spinoff&quot;</span><span class="p">,</span> <span class="nx">capture</span><span class="p">...;</span> <span class="nx">execute</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This method is intended for indicating to a client that the
method that has been used to make the request is not supported
by this service of the internals that are comprising service.
Can be used from the outside, but generally should not be done.
Will be invoked if a method is not defined or not implemented.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">unsupported: </span><span class="nf">(request, response, next) -&gt;</span>
        <span class="nv">method = </span><span class="k">try</span> <span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">codes = </span><span class="nx">http</span><span class="p">.</span><span class="nx">STATUS_CODES</span> <span class="o">or</span> <span class="nb">Object</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">methodNotAllowed = code = </span><span class="mi">405</span> <span class="c1"># HTTP</span>
        <span class="nv">identify = </span><span class="nx">@constructor</span><span class="o">?</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">request</span><span class="p">),</span> <span class="s">&quot;got invalid request&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">next</span><span class="p">),</span> <span class="s">&quot;invalid continuation&quot;</span>
        <span class="nv">notify = </span><span class="s">&quot;Unsupported HTTP method call %s in %s&quot;</span>
        <span class="nx">assert</span> <span class="nv">message = </span><span class="k">try</span> <span class="nx">codes</span><span class="p">[</span><span class="nx">methodNotAllowed</span><span class="p">]</span>
        <span class="nv">doesJson = </span><span class="nx">response</span><span class="p">.</span><span class="nx">accepts</span><span class="p">(</span><span class="sr">/json/</span><span class="p">)</span> <span class="o">or</span> <span class="kc">false</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">writeHead</span> <span class="nx">methodNotAllowed</span><span class="p">,</span> <span class="nx">message</span>
        <span class="nv">descriptor = error: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">message</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nv">code: </span><span class="nx">code</span>
        <span class="nx">@emit</span> <span class="s">&quot;unsupported&quot;</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">next</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">notify</span><span class="p">.</span><span class="nx">red</span><span class="p">,</span> <span class="nx">identify</span><span class="p">,</span> <span class="nx">method</span><span class="p">.</span><span class="nx">bold</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">send</span> <span class="nx">descriptor</span> <span class="k">if</span> <span class="nx">doesJson</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">send</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="k">return</span> <span class="nx">@</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This method determines whether the supplied HTTP request
matches this service. This is determined by examining the
domain/host and the path, in accordance with the patterns
that were used for configuring the class of this service.
It is async, so be sure to call the <code>decide</code> with boolean!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">matches: </span><span class="nf">(request, response, decide) -&gt;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">request</span><span class="p">),</span> <span class="s">&quot;got invalid request&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">decide</span><span class="p">),</span> <span class="s">&quot;incorrect callback&quot;</span>
        <span class="nv">conditions = </span><span class="k">try</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">condition</span><span class="p">()</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">conditions = </span><span class="nb">Array</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">conditions</span>
        <span class="nv">identify = </span><span class="k">try</span> <span class="nx">@constructor</span><span class="o">?</span><span class="p">.</span><span class="nx">identify</span><span class="p">().</span><span class="nx">underline</span>
        <span class="k">return</span> <span class="nx">decide</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">DISABLE_SERVICE</span>
        <span class="nv">p = </span><span class="nf">(i, cn) -&gt;</span> <span class="nx">i</span><span class="p">.</span><span class="nx">limitation</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">cn</span>
        <span class="nv">fails = </span><span class="s">&quot;Service </span><span class="si">#{</span><span class="nx">identify</span><span class="si">}</span><span class="s"> fails some conditions&quot;</span>
        <span class="nv">notify = </span><span class="s">&quot;Running %s service conditional sequences&quot;</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">notify</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">identify</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="k">return</span> <span class="k">super</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nf">(decision) =&gt;</span>
            <span class="k">return</span> <span class="nx">decide</span> <span class="kc">no</span> <span class="k">unless</span> <span class="nx">decision</span> <span class="o">is</span> <span class="kc">yes</span>
            <span class="nx">async</span><span class="p">.</span><span class="nx">every</span> <span class="nx">conditions</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nf">(confirms) -&gt;</span>
                <span class="k">return</span> <span class="nx">decide</span> <span class="kc">yes</span> <span class="k">if</span> <span class="nx">confirms</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">fails</span><span class="p">.</span><span class="nx">yellow</span>
                <span class="nx">decide</span> <span class="kc">no</span><span class="p">;</span> <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Process the already macted HTTP request according to the REST
specification. That is, see if the request method conforms to
to the RFC, and if so, dispatch it onto corresponding method
defined in the subclass of this abstract base class. Default
implementation of each method will throw a not implemented.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">process: </span><span class="nx">@spinoff</span> <span class="nf">(request, response, next) -&gt;</span>
        <span class="nv">method = </span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
        <span class="nv">known = </span><span class="nx">method</span> <span class="k">in</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">SUPPORTED</span>
        <span class="nv">tokens = </span><span class="nx">Service</span><span class="o">::</span><span class="nx">process</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span>
        <span class="k">return</span> <span class="nx">@unsupported</span> <span class="nx">arguments</span><span class="p">...</span> <span class="k">unless</span> <span class="nx">known</span>
        <span class="nx">assert</span> <span class="k">this</span><span class="p">.</span><span class="nx">__isolated</span><span class="p">,</span> <span class="s">&quot;spin-off engine fail&quot;</span>
        <span class="nv">missing = </span><span class="s">&quot;a </span><span class="si">#{</span><span class="nx">method</span><span class="si">}</span><span class="s"> method not implemented&quot;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="nx">missing</span> <span class="k">unless</span> <span class="nx">method</span> <span class="k">of</span> <span class="k">this</span>
        <span class="nv">variables = </span><span class="p">[</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">resource</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">domain</span><span class="p">]</span>
        <span class="nv">headers = </span><span class="nx">@downstream</span> <span class="nv">headers: </span><span class="nf">-&gt;</span> <span class="k">return</span> <span class="kc">null</span>
        <span class="nv">partial = </span><span class="nx">_</span><span class="p">.</span><span class="nx">partial</span> <span class="nx">headers</span><span class="p">,</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span>
        <span class="nx">response</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;header&quot;</span><span class="p">,</span> <span class="nf">-&gt;</span> <span class="nx">partial</span> <span class="nx">variables</span><span class="p">...</span>
        <span class="nx">assert</span> <span class="nv">mw = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">middleware</span><span class="p">().</span><span class="nx">bind</span> <span class="k">this</span>
        <span class="nv">signature = </span><span class="p">[</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">variables</span><span class="p">...]</span>
        <span class="nv">intake = </span><span class="nf">(fn) =&gt;</span> <span class="nx">@downstream</span> <span class="nv">processing: </span><span class="nx">fn</span>
        <span class="nv">go = </span><span class="nf">(fn) =&gt;</span> <span class="nv">usp = </span><span class="nx">intake</span> <span class="nx">fn</span><span class="p">;</span> <span class="nx">usp</span> <span class="nx">signature</span><span class="p">...</span>
        <span class="nx">go</span> <span class="o">=&gt;</span> <span class="nx">mw</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="nf">(error, results, misc) =&gt;</span>
            <span class="nx">assert</span> <span class="nv">expanded = </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">variables</span> <span class="o">or</span> <span class="p">[]</span>
            <span class="nx">expanded</span><span class="p">.</span><span class="nx">push</span> <span class="nx">request</span><span class="p">.</span><span class="nx">session</span> <span class="o">or</span> <span class="kc">undefined</span>
            <span class="k">this</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">expanded</span><span class="p">...</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Reject the request by sending an error descriptor object as a
response. The error descriptor is a top level object that will
embed the rejection information inside of itself. Optionally
you can supply the HTTP code that corresponds to a rejection.
Please use this methods rather than sending errors directly!</p></div></div><div class="code"><div class="wrapper">    <span class="nv">reject: </span><span class="nf">(content, code, keepalive) -&gt;</span>
        <span class="nv">code = </span><span class="mi">400</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nx">code</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">noContent = </span><span class="s">&quot;the content has to be an object&quot;</span>
        <span class="nv">corrupted = </span><span class="s">&quot;response prototype is corrupted&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@response</span><span class="p">),</span> <span class="s">&quot;got no response&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@response</span><span class="p">.</span><span class="nx">send</span><span class="p">),</span> <span class="nx">corrupted</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">content</span> <span class="o">or</span> <span class="kc">null</span><span class="p">),</span> <span class="nx">noContent</span>
        <span class="nx">assert</span> <span class="k">this</span><span class="p">.</span><span class="nx">__isolated</span><span class="p">,</span> <span class="s">&quot;broken spin off engine&quot;</span>
        <span class="nv">upload = </span><span class="o">=&gt;</span> <span class="k">return</span> <span class="nx">@response</span><span class="p">.</span><span class="nx">send</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">content</span>
        <span class="nv">flushd = </span><span class="o">=&gt;</span> <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="nf">-&gt;</span> <span class="nx">upload</span><span class="p">()</span>
        <span class="nv">rejection = </span><span class="k">this</span><span class="p">.</span><span class="nx">downstream</span> <span class="nv">rejection: </span><span class="nx">flushd</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">emit</span> <span class="s">&quot;reject&quot;</span><span class="p">,</span> <span class="nx">@response</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
        <span class="k">return</span> <span class="nx">rejection</span> <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">,</span> <span class="nx">content</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Push the supplied content to the requester by utilizing the
response object. This is effectively the same as calling the
<code>response.send</code> directly, but this method is wired into the
system of service hooks. Refer to the original sender for
more information on how the content is encoded and passed.</p></div></div><div class="code"><div class="wrapper">    <span class="nv">push: </span><span class="nf">(content, code, keepalive) -&gt;</span>
        <span class="nv">code = </span><span class="mi">200</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nx">code</span> <span class="o">or</span> <span class="kc">null</span>
        <span class="nv">corrupted = </span><span class="s">&quot;a response prototype is corrupted&quot;</span>
        <span class="nv">carrier = </span><span class="s">&quot;has to be either an object or array&quot;</span>
        <span class="nv">ok = </span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">@response</span><span class="p">),</span> <span class="s">&quot;got no response&quot;</span>
        <span class="nx">assert</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@response</span><span class="p">.</span><span class="nx">send</span><span class="p">),</span> <span class="nx">corrupted</span>
        <span class="nx">assert</span> <span class="nx">content</span> <span class="o">and</span> <span class="nx">ok</span> <span class="o">is</span> <span class="kc">yes</span><span class="p">,</span> <span class="nx">carrier</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="k">this</span><span class="p">.</span><span class="nx">__isolated</span><span class="p">,</span> <span class="s">&quot;broken spin off engine&quot;</span>
        <span class="nx">@emit</span> <span class="s">&quot;push&quot;</span><span class="p">,</span> <span class="nx">@response</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">keepalive</span>
        <span class="nv">upload = </span><span class="o">=&gt;</span> <span class="k">return</span> <span class="nx">@response</span><span class="p">.</span><span class="nx">send</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">content</span>
        <span class="nv">flushd = </span><span class="o">=&gt;</span> <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">nextTick</span> <span class="nf">-&gt;</span> <span class="nx">upload</span><span class="p">()</span>
        <span class="nx">assert</span> <span class="nv">pushing = </span><span class="nx">@downstream</span> <span class="nv">pushing: </span><span class="nx">flushd</span>
        <span class="k">return</span> <span class="nx">pushing</span> <span class="k">this</span><span class="p">.</span><span class="nx">response</span><span class="p">,</span> <span class="nx">content</span></div></div></div></div></body></html>